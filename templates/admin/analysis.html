{% extends "base.html" %}

{% block title %}Analysis Dashboard - Fund Allocation Optimizer{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .metric-card.warning {
        border-left-color: #ffc107;
    }
    .metric-card.danger {
        border-left-color: #dc3545;
    }
    .metric-card.success {
        border-left-color: #28a745;
    }
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .metric-change {
        font-size: 0.9rem;
    }
    .metric-change.positive {
        color: #28a745;
    }
    .metric-change.negative {
        color: #dc3545;
    }
    .chart-container {
        height: 300px;
        margin-bottom: 2rem;
    }
    .comparison-table th {
        background-color: #f1f8ff;
    }
    .savings-highlight {
        color: #28a745;
        font-weight: bold;
    }
    .loss-highlight {
        color: #dc3545;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        {% include "admin/sidebar.html" %}
    </div>
    <div class="col-md-9">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-graph-up"></i> Analysis Dashboard</h4>
            </div>
            <div class="card-body">


                <!-- Analysis Results Section -->
                {% if analysis_results %}
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Analysis Results</h5>
                            </div>
                            <div class="card-body">
                                <!-- Performance Comparison -->
                                <h6 class="mb-3">Performance Comparison</h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered comparison-table">
                                        <thead>
                                            <tr>
                                                <th>Metric</th>
                                                <th>Current</th>
                                                <th>Best Available</th>
                                                <th>Potential Improvement</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Total Balance</td>
                                                <td>${{ '{:,.2f}'.format(analysis_results.total_balance) }}</td>
                                                <td>${{ '{:,.2f}'.format(analysis_results.total_balance) }}</td>
                                                <td>-</td>
                                            </tr>
                                            <tr>
                                                <td>Average Rate</td>
                                                <td>{{ '{:.3f}'.format(analysis_results.average_rate) }}%</td>
                                                <td>{{ '{:.3f}'.format(analysis_results.average_rate + analysis_results.potential_rate_increase) }}%</td>
                                                <td class="savings-highlight">+{{ '{:.3f}'.format(analysis_results.potential_rate_increase) }}%</td>
                                            </tr>
                                            <tr>
                                                <td>Monthly Interest</td>
                                                <td>${{ '{:,.2f}'.format(analysis_results.current_monthly_interest) }}</td>
                                                <td>${{ '{:,.2f}'.format(analysis_results.best_monthly_interest) }}</td>
                                                <td class="savings-highlight">+${{ '{:,.2f}'.format(analysis_results.monthly_interest_increase) }}</td>
                                            </tr>
                                            <tr>
                                                <td>Annual Interest</td>
                                                <td>${{ '{:,.2f}'.format(analysis_results.current_annual_interest) }}</td>
                                                <td>${{ '{:,.2f}'.format(analysis_results.best_annual_interest) }}</td>
                                                <td class="savings-highlight">+${{ '{:,.2f}'.format(analysis_results.annual_interest_increase) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Underperforming Accounts -->
                                <h6 class="mt-4 mb-3">Top 10 Underperforming Accounts</h6>
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Account</th>
                                                <th>Bank/Holder</th>
                                                <th>Product Type</th>
                                                <th>Current Rate</th>
                                                <th>Best Available Rate</th>
                                                <th>Current Balance</th>
                                                <th>Annual Loss</th>
                                                <th>Maturity Date</th>
                                                <th>Recommendation</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for account in analysis_results.underperforming[:10] %}
                                            <tr>
                                                <td>{{ account.name }}</td>
                                                <td>{{ account.holder }}</td>
                                                <td>{{ account.product_type }}</td>
                                                <td class="loss-highlight">{{ '{:.3f}'.format(account.current_rate) }}%</td>
                                                <td class="savings-highlight">{{ '{:.3f}'.format(account.best_rate) }}%</td>
                                                <td>${{ '{:,.2f}'.format(account.balance) }}</td>
                                                <td class="loss-highlight">-${{ '{:,.2f}'.format(account.annual_loss) }}</td>
                                                <td>{{ account.maturity_date }}</td>
                                                <td>{{ account.recommendation }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Download Options -->
                                <div class="text-center mt-4">
                                    <div class="row justify-content-center">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title"><i class="bi bi-download"></i> Download Options</h5>
                                                    <p class="card-text">Download the complete analysis report including all underperforming accounts and detailed metrics.</p>
                                                    <a href="{{ url_for('download_analysis_report') }}" class="btn btn-success btn-lg">
                                                        <i class="bi bi-file-earmark-excel"></i> Download Full Report
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Summary Metrics -->
                {% if analysis_results %}
                <div class="row mb-4">
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card metric-card warning">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Non-Partner Bank Funds</h6>
                                <div class="metric-value">${{ "%.1f"|format(analysis_results.non_partner_funds/1000000) }}M</div>
                                <div class="metric-change {% if analysis_results.non_partner_change > 0 %}negative{% else %}positive{% endif %}">
                                    <i class="bi bi-arrow-{{ analysis_results.non_partner_change_direction }}"></i>
                                    {{ "%.1f"|format(analysis_results.non_partner_change_display) }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card metric-card danger">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Underperforming Funds</h6>
                                <div class="metric-value">${{ "%.1f"|format(analysis_results.underperforming_funds/1000000) }}M</div>
                                <div class="metric-change {% if analysis_results.underperforming_change > 0 %}negative{% else %}positive{% endif %}">
                                    <i class="bi bi-arrow-{{ analysis_results.underperforming_change_direction }}"></i>
                                    {{ "%.1f"|format(analysis_results.underperforming_change_display) }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card metric-card success">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Average Rate</h6>
                                <div class="metric-value">{{ "%.2f"|format(analysis_results.average_rate) }}%</div>
                                <div class="metric-change {% if analysis_results.rate_change > 0 %}positive{% else %}negative{% endif %}">
                                    <i class="bi bi-arrow-{{ analysis_results.rate_change_direction }}"></i>
                                    {{ "%.2f"|format(analysis_results.rate_change_display) }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card metric-card success">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Potential Rate Increase</h6>
                                <div class="metric-value">{{ "%.2f"|format(analysis_results.potential_rate_increase) }}%</div>
                                <div class="text-muted small">
                                    If optimally allocated
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Rate Performance Analysis -->
                {% if analysis_results and analysis_results.rate_chart %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Rate Performance Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container mb-4">
                            <canvas id="ratePerformanceChart"></canvas>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Term</th>
                                        <th>Current Average Rate</th>
                                        <th>Best Available Rate</th>
                                        <th>Funds at Lower Rates</th>
                                        <th>Potential Annual Increase</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for term in analysis_results.rate_analysis %}
                                    <tr>
                                        <td>{{ term.name }}</td>
                                        <td>{{ "%.2f"|format(term.current_avg_rate) }}%</td>
                                        <td>{{ "%.2f"|format(term.best_rate) }}%</td>
                                        <td>${{ "%.1f"|format(term.underperforming_funds/1000000) }}M</td>
                                        <td>${{ "%.1f"|format(term.potential_increase/1000000) }}M</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Maturity Analysis -->
                {% if analysis_results and analysis_results.maturity_chart %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-calendar"></i> Maturity Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="maturityChart"></canvas>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    


    // Initialize Charts if analysis results exist
    {% if analysis_results and analysis_results.rate_chart %}
    const rateChartCtx = document.getElementById('ratePerformanceChart');
    if (rateChartCtx) {
        const rateChartData = {
            labels: {{ analysis_results.rate_chart.labels|tojson }},
            datasets: [{
                label: 'Current Average Rate',
                data: {{ analysis_results.rate_chart.current_rates|tojson }},
                borderColor: 'rgba(220, 53, 69, 1)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                fill: true
            }, {
                label: 'Best Available Rate',
                data: {{ analysis_results.rate_chart.best_rates|tojson }},
                borderColor: 'rgba(40, 167, 69, 1)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                fill: true
            }]
        };
        
        new Chart(rateChartCtx, {
            type: 'line',
            data: rateChartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}

    {% if analysis_results and analysis_results.maturity_chart %}
    const maturityChartCtx = document.getElementById('maturityChart');
    if (maturityChartCtx) {
        const maturityChartData = {
            labels: {{ analysis_results.maturity_chart.labels|tojson }},
            datasets: [{
                label: 'Maturing Funds',
                data: {{ analysis_results.maturity_chart.amounts|tojson }},
                backgroundColor: 'rgba(0, 123, 255, 0.5)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 1
            }]
        };
        
        new Chart(maturityChartCtx, {
            type: 'bar',
            data: maturityChartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + (value/1000000).toFixed(1) + 'M';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %} 