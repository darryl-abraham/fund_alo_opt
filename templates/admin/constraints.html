{% extends "base.html" %}

{% block title %}Optimization Constraints - Fund Allocation Optimizer{% endblock %}

{% block extra_css %}
<style>
    .constraint-slider {
        width: 100%;
    }
    .constraint-card {
        transition: all 0.3s ease;
    }
    .constraint-card.disabled {
        opacity: 0.6;
        background-color: #f8f9fa;
    }
    .constraint-card.disabled input[type="range"] {
        opacity: 0.4;
        cursor: not-allowed;
    }
    .constraint-card.disabled .constraint-value-display {
        opacity: 0.6;
        color: #6c757d;
    }
    .category-card.disabled {
        opacity: 0.6;
        background-color: #f8f9fa;
    }
    .category-card.disabled .constraint-card {
        opacity: 0.6;
        background-color: #f8f9fa;
    }
    .category-card.disabled .category-weight-container {
        opacity: 0.6;
    }
    .category-card.disabled input[type="range"] {
        opacity: 0.4;
        cursor: not-allowed;
    }
    .category-card.disabled .category-weight-value {
        opacity: 0.6;
        color: #6c757d;
    }
    .reset-btn {
        position: absolute;
        right: 10px;
        top: 10px;
    }
    /* Added style for the special linked sliders */
    .linked-slider-container {
        position: relative;
    }
    .linked-slider-hint {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: -10px;
        margin-bottom: 10px;
    }
    .category-weight-container {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 5px;
    }
    .category-weight-label {
        margin-right: 15px;
        font-weight: bold;
        min-width: 130px;
    }
    .category-weight-slider {
        flex-grow: 1;
        margin-right: 10px;
    }
    .category-weight-value {
        min-width: 40px;
        text-align: center;
        font-weight: bold;
    }
    .constraint-value-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .constraint-value-label {
        margin-right: 15px;
        font-weight: bold;
        min-width: 100px;
    }
    .constraint-value-slider {
        flex-grow: 1;
        margin-right: 10px;
    }
    .constraint-value-display {
        min-width: 40px;
        text-align: center;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        {% include "admin/sidebar.html" %}
    </div>
    <div class="col-md-9">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-sliders"></i> Optimization Constraints</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> About Constraints</h5>
                    <p>Adjust the values below to control how the optimization algorithm allocates funds:</p>
                    <ul>
                        <li><strong>Value sliders</strong>: Set relative preference within a category (higher values = higher priority)</li>
                        <li><strong>Category weight</strong>: Controls the overall importance of this category in the final calculation</li>
                    </ul>
                    <p class="mb-0">Disable constraints to ignore them completely.</p>
                </div>
                
                <!-- Product Selection -->
                <div class="card mb-4 category-card {% if product_category_weight == 0 %}disabled{% endif %}" id="product_category_card">
                    <div class="card-header bg-success text-white position-relative">
                        <h5 class="mb-0"><i class="bi bi-basket"></i> Product Selection</h5>
                        <div class="form-check form-switch position-absolute" style="right: 10px; top: 10px;">
                            <input class="form-check-input category-toggle" type="checkbox" id="product_category_toggle" 
                                   data-category="product" {% if product_category_weight > 0 %}checked{% endif %}>
                            <label class="form-check-label text-white" for="product_category_toggle">Enable</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="product_category_weight" 
                                   name="category_weight" min="0" max="100" step="1" value="{{ product_category_weight * 100 }}"
                                   {% if product_category_weight == 0 %}disabled{% endif %}>
                            <span class="category-weight-value" id="product_weight_display">{{ "%.0f%%"|format(product_category_weight * 100) }}</span>
                        </div>
                        
                        <div class="row">
                            {% for product in products.itertuples() %}
                            <div class="col-md-4 mb-3">
                                <div class="card constraint-card product {% if not product.is_enabled %}disabled{% endif %}" data-id="{{ product.id }}">
                                    <div class="card-body">
                                        <form method="post" action="{{ url_for('admin_update_constraint') }}" onsubmit="return false;">
                                            <input type="hidden" name="id" value="{{ product.id }}">
                                            <input type="hidden" name="category" value="{{ product.category }}">
                                            
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ product.id }}" name="is_enabled" {% if product.is_enabled %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_{{ product.id }}">
                                                    <strong>{{ product.name }}</strong>
                                                </label>
                                            </div>
                                            
                                            <div class="constraint-value-container">
                                                <span class="constraint-value-label">Value:</span>
                                                <input type="range" class="form-range constraint-slider product-value-slider" 
                                                       id="value_{{ product.id }}" name="value" min="0" max="100" step="1" 
                                                       value="{{ product.value * 100 }}" {% if not product.is_enabled %}disabled{% endif %}>
                                                <span class="constraint-value-display">{{ "%.0f%%"|format(product.value * 100) }}</span>
                                            </div>
                                            
                                            <input type="hidden" name="weight" value="{{ product_category_weight }}">
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Time Selection -->
                <div class="card mb-4 category-card {% if time_category_weight == 0 %}disabled{% endif %}" id="time_category_card">
                    <div class="card-header bg-info text-white position-relative">
                        <h5 class="mb-0"><i class="bi bi-clock"></i> Time Selection</h5>
                        <div class="form-check form-switch position-absolute" style="right: 10px; top: 10px;">
                            <input class="form-check-input category-toggle" type="checkbox" id="time_category_toggle" 
                                   data-category="time" {% if time_category_weight > 0 %}checked{% endif %}>
                            <label class="form-check-label text-white" for="time_category_toggle">Enable</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="time_category_weight" 
                                   name="category_weight" min="0" max="100" step="1" value="{{ time_category_weight * 100 }}"
                                   {% if time_category_weight == 0 %}disabled{% endif %}>
                            <span class="category-weight-value" id="time_weight_display">{{ "%.0f%%"|format(time_category_weight * 100) }}</span>
                        </div>
                        
                        <div class="row">
                            {% for time in times.itertuples() %}
                            <div class="col-md-4 mb-3">
                                <div class="card constraint-card time {% if not time.is_enabled %}disabled{% endif %}" data-id="{{ time.id }}">
                                    <div class="card-body">
                                        <form method="post" action="{{ url_for('admin_update_constraint') }}" onsubmit="return false;">
                                            <input type="hidden" name="id" value="{{ time.id }}">
                                            <input type="hidden" name="category" value="{{ time.category }}">
                                            
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ time.id }}" name="is_enabled" {% if time.is_enabled %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_{{ time.id }}">
                                                    <strong>{{ time.name }}</strong>
                                                </label>
                                            </div>
                                            
                                            <div class="constraint-value-container">
                                                <span class="constraint-value-label">Value:</span>
                                                <input type="range" class="form-range constraint-slider time-value-slider" 
                                                       id="value_{{ time.id }}" name="value" min="0" max="100" step="1" 
                                                       value="{{ time.value * 100 }}" {% if not time.is_enabled %}disabled{% endif %}>
                                                <span class="constraint-value-display">{{ "%.0f%%"|format(time.value * 100) }}</span>
                                            </div>
                                            
                                            <input type="hidden" name="weight" value="{{ time_category_weight }}">
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Weighting Factors -->
                <div class="card mb-4 category-card {% if weighting_category_weight == 0 %}disabled{% endif %}" id="weighting_category_card">
                    <div class="card-header bg-warning text-dark position-relative">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Weighting Factors</h5>
                        <div class="form-check form-switch position-absolute" style="right: 10px; top: 10px;">
                            <input class="form-check-input category-toggle" type="checkbox" id="weighting_category_toggle" 
                                   data-category="weighting" {% if weighting_category_weight > 0 %}checked{% endif %}>
                            <label class="form-check-label text-dark" for="weighting_category_toggle">Enable</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="weighting_category_weight" 
                                   name="category_weight" min="0" max="100" step="1" value="{{ weighting_category_weight * 100 }}"
                                   {% if weighting_category_weight == 0 %}disabled{% endif %}>
                            <span class="category-weight-value" id="weighting_weight_display">{{ "%.0f%%"|format(weighting_category_weight * 100) }}</span>
                        </div>
                        
                        <div class="alert alert-info">
                            <p class="mb-0"><i class="bi bi-info-circle"></i> The values for Interest Rates and ECR Return are linked and will always sum to 1.0. Adjusting one will automatically update the other.</p>
                        </div>
                        <div class="row">
                            {% for weight in weightings.itertuples() %}
                            <div class="col-md-6 mb-3">
                                <div class="card constraint-card weight {% if not weight.is_enabled %}disabled{% endif %}" data-id="{{ weight.id }}">
                                    <div class="card-body">
                                        <form method="post" action="{{ url_for('admin_update_constraint') }}" onsubmit="return false;">
                                            <input type="hidden" name="id" value="{{ weight.id }}">
                                            <input type="hidden" name="category" value="{{ weight.category }}">
                                            
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ weight.id }}" name="is_enabled" {% if weight.is_enabled %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_{{ weight.id }}">
                                                    <strong>{{ weight.name }}</strong>
                                                </label>
                                            </div>
                                            
                                            <div class="constraint-value-container">
                                                <span class="constraint-value-label">Value:</span>
                                                <input type="range" class="form-range constraint-slider weighting-slider" 
                                                       id="value_{{ weight.id }}" 
                                                       name="value" 
                                                       min="0" 
                                                       max="100" 
                                                       step="1" 
                                                       value="{{ weight.value * 100 }}" 
                                                       data-weight-name="{{ weight.name }}"
                                                       {% if not weight.is_enabled %}disabled{% endif %}>
                                                <span class="constraint-value-display">{{ "%.0f%%"|format(weight.value * 100) }}</span>
                                            </div>
                                            
                                            <input type="hidden" name="weight" value="{{ weighting_category_weight }}">
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Bank Prioritization -->
                <div class="card mb-4 category-card {% if bank_category_weight == 0 %}disabled{% endif %}" id="bank_category_card">
                    <div class="card-header bg-secondary text-white position-relative">
                        <h5 class="mb-0"><i class="bi bi-bank"></i> Bank Prioritization</h5>
                        <div class="form-check form-switch position-absolute" style="right: 10px; top: 10px;">
                            <input class="form-check-input category-toggle" type="checkbox" id="bank_category_toggle" 
                                   data-category="bank" {% if bank_category_weight > 0 %}checked{% endif %}>
                            <label class="form-check-label text-white" for="bank_category_toggle">Enable</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="bank_category_weight" 
                                   name="category_weight" min="0" max="100" step="1" value="{{ bank_category_weight * 100 }}"
                                   {% if bank_category_weight == 0 %}disabled{% endif %}>
                            <span class="category-weight-value" id="bank_weight_display">{{ "%.0f%%"|format(bank_category_weight * 100) }}</span>
                        </div>
                        
                        <div class="row">
                            {% for bank in banks.itertuples() %}
                            <div class="col-md-4 mb-3">
                                <div class="card constraint-card bank {% if not bank.is_enabled %}disabled{% endif %}" data-id="{{ bank.id }}">
                                    <div class="card-body">
                                        <form method="post" action="{{ url_for('admin_update_constraint') }}" onsubmit="return false;">
                                            <input type="hidden" name="id" value="{{ bank.id }}">
                                            <input type="hidden" name="category" value="{{ bank.category }}">
                                            
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ bank.id }}" name="is_enabled" {% if bank.is_enabled %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_{{ bank.id }}">
                                                    <strong>{{ bank.name }}</strong>
                                                </label>
                                            </div>
                                            
                                            <div class="constraint-value-container">
                                                <span class="constraint-value-label">Value:</span>
                                                <input type="range" class="form-range constraint-slider bank-value-slider" 
                                                       id="value_{{ bank.id }}" name="value" min="0" max="100" step="1" 
                                                       value="{{ bank.value * 100 }}" {% if not bank.is_enabled %}disabled{% endif %}>
                                                <span class="constraint-value-display">{{ "%.0f%%"|format(bank.value * 100) }}</span>
                                            </div>
                                            
                                            <input type="hidden" name="weight" value="{{ bank_category_weight }}">
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Liquidity Constraints -->
                <div class="card mb-4 category-card {% if liquidity_category_weight == 0 %}disabled{% endif %}" id="liquidity_category_card">
                    <div class="card-header bg-info text-white position-relative">
                        <h5 class="mb-0"><i class="bi bi-droplet"></i> Liquidity Constraints</h5>
                        <div class="form-check form-switch position-absolute" style="right: 10px; top: 10px;">
                            <input class="form-check-input category-toggle" type="checkbox" id="liquidity_category_toggle" 
                                   data-category="liquidity" {% if liquidity_category_weight > 0 %}checked{% endif %}>
                            <label class="form-check-label text-white" for="liquidity_category_toggle">Enable</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="liquidity_category_weight" 
                                   name="category_weight" min="0" max="100" step="1" value="{{ liquidity_category_weight * 100 }}"
                                   {% if liquidity_category_weight == 0 %}disabled{% endif %}>
                            <span class="category-weight-value" id="liquidity_weight_display">{{ "%.0f%%"|format(liquidity_category_weight * 100) }}</span>
                        </div>
                        
                        <div class="row">
                            {% for constraint in liquidity.itertuples() %}
                            <div class="col-md-6 mb-3">
                                <div class="card constraint-card liquidity {% if not constraint.is_enabled %}disabled{% endif %}" data-id="{{ constraint.id }}">
                                    <div class="card-body">
                                        <form method="post" action="{{ url_for('admin_update_constraint') }}" onsubmit="return false;" class="liquidity-form">
                                            <input type="hidden" name="id" value="{{ constraint.id }}">
                                            <input type="hidden" name="category" value="{{ constraint.category }}">
                                            <input type="hidden" name="weight" value="{{ liquidity_category_weight }}">
                                            
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input constraint-toggle" type="checkbox" 
                                                       id="enable_{{ constraint.id }}" name="is_enabled" 
                                                       {% if constraint.is_enabled %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_{{ constraint.id }}">
                                                    <strong>{{ constraint.name }}</strong>
                                                </label>
                                            </div>
                                            
                                            <div class="constraint-value-container">
                                                <span class="constraint-value-label">Reserve Percentage:</span>
                                                <input type="range" class="form-range liquidity-slider" name="display_value" 
                                                       min="0" max="100" step="1" value="{{ constraint.value * 100 }}"
                                                       {% if not constraint.is_enabled %}disabled{% endif %}>
                                                <span class="constraint-value-display">{{ "%.0f%%"|format(constraint.value * 100) }}</span>
                                            </div>

                                            <input type="hidden" name="value" value="{{ constraint.value }}">
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Save All Changes -->
                <div class="card mt-4">
                    <div class="card-body text-center">
                        <button type="button" class="btn btn-primary btn-lg save-all-changes">
                            <i class="bi bi-save"></i> Save All Changes
                        </button>
                    </div>
                </div>

                <!-- Reset All Constraints -->
                <div class="card mt-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Reset All Constraints</h5>
                    </div>
                    <div class="card-body">
                        <p>This will reset all constraints to their default values.</p>
                        <button type="button" class="btn btn-danger category-reset-btn" data-category="all">
                            <i class="bi bi-arrow-repeat"></i> Reset All Constraints
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle category toggles
    const categoryToggles = document.querySelectorAll('.category-toggle');
    categoryToggles.forEach(toggle => {
        toggle.addEventListener('change', function() {
            const category = this.dataset.category;
            const categoryCard = document.getElementById(`${category}_category_card`);
            const slider = document.getElementById(`${category}_category_weight`);
            const display = document.getElementById(`${category}_weight_display`);
            
            if (this.checked) {
                // Enable the category
                categoryCard.classList.remove('disabled');
                slider.disabled = false;
                if (slider.value === '0') {
                    // Calculate default value based on other enabled sliders
                    const enabledSliders = getEnabledCategorySliders();
                    const totalValue = enabledSliders.reduce((sum, s) => sum + parseFloat(s.value), 0);
                    const defaultValue = Math.round((100 - totalValue) / (enabledSliders.length + 1));
                    slider.value = defaultValue;
                    display.textContent = defaultValue + '%';
                    // Redistribute other sliders
                    updateLinkedCategoryWeights();
                }
            } else {
                // Disable the category
                categoryCard.classList.add('disabled');
                slider.disabled = true;
                slider.value = '0';
                display.textContent = '0%';
                // Redistribute other sliders
                updateLinkedCategoryWeights();
            }
        });
    });

    // Handle individual constraint toggles
    const constraintToggles = document.querySelectorAll('.constraint-toggle');
    constraintToggles.forEach(toggle => {
        toggle.addEventListener('change', function() {
            const constraintCard = this.closest('.constraint-card');
            const valueSlider = constraintCard.querySelector('input[type="range"]');
            const valueDisplay = constraintCard.querySelector('.constraint-value-display');
            
            if (this.checked) {
                // Enable the constraint
                constraintCard.classList.remove('disabled');
                if (valueSlider) {
                    valueSlider.disabled = false;
                }
            } else {
                // Disable the constraint
                constraintCard.classList.add('disabled');
                if (valueSlider) {
                    valueSlider.disabled = true;
                }
            }
        });
    });

    // Function to get enabled category sliders (excluding liquidity)
    const getEnabledCategorySliders = () => {
        const categorySliders = document.querySelectorAll('.category-weight-slider');
        return Array.from(categorySliders).filter(slider => {
            const category = slider.id.split('_')[0];
            return category !== 'liquidity' && !slider.disabled;
        });
    };

    // Function to update linked category weights
    const updateLinkedCategoryWeights = () => {
        const enabledSliders = getEnabledCategorySliders();
        if (enabledSliders.length === 0) return;

        // Calculate total of all enabled sliders
        const total = enabledSliders.reduce((sum, slider) => sum + parseFloat(slider.value), 0);
        
        // If total is not 100, adjust values proportionally
        if (total !== 100) {
            enabledSliders.forEach(slider => {
                const currentValue = parseFloat(slider.value);
                let newValue;
                if (total === 0) {
                    // If total is 0, distribute evenly
                    newValue = Math.round(100 / enabledSliders.length);
                } else {
                    // Otherwise, adjust proportionally
                    newValue = Math.round((currentValue / total) * 100);
                }
                slider.value = newValue;
                
                // Update display
                const display = document.getElementById(slider.id.replace('category_weight', 'weight_display'));
                if (display) {
                    display.textContent = newValue + '%';
                }
            });
        }
    };

    // Add event listeners to category weight sliders
    const categoryWeightSliders = document.querySelectorAll('.category-weight-slider');
    categoryWeightSliders.forEach(slider => {
        slider.addEventListener('input', function() {
            const display = document.getElementById(this.id.replace('category_weight', 'weight_display'));
            if (display) {
                display.textContent = this.value + '%';
            }
            if (this.id.split('_')[0] !== 'liquidity') {  // Only link non-liquidity sliders
                updateLinkedCategoryWeights();
            }
        });
    });

    // Initialize category weights to ensure they sum to 100
    updateLinkedCategoryWeights();

    // Link value sliders within each category
    const linkCategoryValueSliders = (category) => {
        const sliders = document.querySelectorAll(`.${category}-value-slider`);
        const updateLinkedValues = (changedSlider) => {
            const otherSliders = Array.from(sliders).filter(s => s !== changedSlider);
            const otherTotal = otherSliders.reduce((sum, slider) => sum + parseFloat(slider.value), 0);
            const remaining = 100 - parseFloat(changedSlider.value);
            
            if (otherTotal > 0) {
                otherSliders.forEach(slider => {
                    const currentValue = parseFloat(slider.value);
                    const newValue = Math.round((currentValue / otherTotal) * remaining);
                    slider.value = newValue;
                    
                    const display = slider.parentElement.querySelector('.constraint-value-display');
                    if (display) {
                        display.textContent = newValue + '%';
                    }
                });
            }
        };
        
        sliders.forEach(slider => {
            slider.addEventListener('input', function() {
                const display = this.parentElement.querySelector('.constraint-value-display');
                if (display) {
                    display.textContent = this.value + '%';
                }
                updateLinkedValues(this);
            });
        });
    };

    // Link value sliders for each category
    linkCategoryValueSliders('product');
    linkCategoryValueSliders('time');
    linkCategoryValueSliders('bank');

    // Special handling for liquidity sliders
    const liquiditySliders = document.querySelectorAll('.liquidity-slider');
    liquiditySliders.forEach(slider => {
        slider.addEventListener('input', function() {
            const display = this.parentElement.querySelector('.constraint-value-display');
            if (display) {
                display.textContent = this.value + '%';
            }
            // Update hidden value field
            const hiddenValue = this.form.querySelector('input[name="value"]');
            if (hiddenValue) {
                hiddenValue.value = parseFloat(this.value) / 100;
            }
        });
    });

    // Special handling for weighting sliders
    const weightingSliders = document.querySelectorAll('.weighting-slider');
    if (weightingSliders.length === 2) {
        const interestSlider = Array.from(weightingSliders).find(slider => 
            slider.getAttribute('data-weight-name') === 'Interest Rates');
        const ecrSlider = Array.from(weightingSliders).find(slider => 
            slider.getAttribute('data-weight-name') === 'ECR Return');
            
        if (interestSlider && ecrSlider) {
            const updateLinkedSlider = (primarySlider, secondarySlider) => {
                const primaryValue = parseFloat(primarySlider.value);
                const newSecondaryValue = Math.round((1 - primaryValue) * 100) / 100;
                secondarySlider.value = newSecondaryValue;
                const displayElement = secondarySlider.parentElement.querySelector('.value-display');
                if (displayElement) {
                    displayElement.textContent = newSecondaryValue;
                }
            };
            
            interestSlider.addEventListener('input', function() {
                updateLinkedSlider(this, ecrSlider);
            });
            
            ecrSlider.addEventListener('input', function() {
                updateLinkedSlider(this, interestSlider);
            });
        }
    }

    // Save all changes functionality
    const saveAllButton = document.querySelector('.save-all-changes');
    saveAllButton.addEventListener('click', async function() {
        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
        
        try {
            // Get all forms
            const forms = document.querySelectorAll('form[action*="admin_update_constraint"]');
            const categoryWeights = document.querySelectorAll('.category-weight-slider');
            
            // Save category weights first
            for (const weightSlider of categoryWeights) {
                const category = weightSlider.id.split('_')[0];
                const weightValue = parseFloat(weightSlider.value) / 100;
                
                await fetch('{{ url_for("admin_update_category_weight") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `category=${category}&weight=${weightValue}`
                });
            }
            
            // Save all constraint forms
            for (const form of forms) {
                const formData = new FormData(form);
                await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });
            }
            
            // Show success message
            this.innerHTML = '<i class="bi bi-check-circle"></i> Changes Saved Successfully';
            this.classList.remove('btn-primary');
            this.classList.add('btn-success');
            
            setTimeout(() => {
                this.innerHTML = '<i class="bi bi-save"></i> Save All Changes';
                this.classList.remove('btn-success');
                this.classList.add('btn-primary');
                this.disabled = false;
            }, 2000);
            
        } catch (error) {
            console.error('Error saving changes:', error);
            this.innerHTML = '<i class="bi bi-x-circle"></i> Error Saving Changes';
            this.classList.remove('btn-primary');
            this.classList.add('btn-danger');
            
            setTimeout(() => {
                this.innerHTML = '<i class="bi bi-save"></i> Save All Changes';
                this.classList.remove('btn-danger');
                this.classList.add('btn-primary');
                this.disabled = false;
            }, 2000);
        }
    });
});
</script>
{% endblock %} 