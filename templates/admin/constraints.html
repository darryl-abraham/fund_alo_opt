{% extends "base.html" %}

{% block title %}Optimization Constraints - Fund Allocation Optimizer{% endblock %}

{% block extra_css %}
<style>
    .constraint-slider {
        width: 100%;
    }
    .constraint-card {
        transition: all 0.3s ease;
    }
    .constraint-card.disabled {
        opacity: 0.6;
        background-color: #f8f9fa;
    }
    .constraint-card.disabled input[type="range"] {
        opacity: 0.4;
        cursor: not-allowed;
    }
    .constraint-card.disabled .constraint-value-display {
        opacity: 0.6;
        color: #6c757d;
    }
    .category-card.disabled {
        opacity: 0.6;
        background-color: #f8f9fa;
    }
    .category-card.disabled .constraint-card {
        opacity: 0.6;
        background-color: #f8f9fa;
    }
    .category-card.disabled .category-weight-container {
        opacity: 0.6;
    }
    .category-card.disabled input[type="range"] {
        opacity: 0.4;
        cursor: not-allowed;
    }
    .category-card.disabled .category-weight-value {
        opacity: 0.6;
        color: #6c757d;
    }
    .reset-btn {
        position: absolute;
        right: 10px;
        top: 10px;
    }
    /* Added style for the special linked sliders */
    .linked-slider-container {
        position: relative;
    }
    .linked-slider-hint {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: -10px;
        margin-bottom: 10px;
    }
    .category-weight-container {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 5px;
    }
    .category-weight-label {
        margin-right: 15px;
        font-weight: bold;
        min-width: 130px;
    }
    .category-weight-slider {
        flex-grow: 1;
        margin-right: 10px;
    }
    .category-weight-value {
        min-width: 40px;
        text-align: center;
        font-weight: bold;
    }
    .constraint-value-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .constraint-value-label {
        margin-right: 15px;
        font-weight: bold;
        min-width: 100px;
    }
    .constraint-value-slider {
        flex-grow: 1;
        margin-right: 10px;
    }
    .constraint-value-display {
        min-width: 40px;
        text-align: center;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        {% include "admin/sidebar.html" %}
    </div>
    <div class="col-md-9">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-sliders"></i> Optimization Constraints</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> About Constraints</h5>
                    <p>Adjust the values below to control how the optimization algorithm allocates funds:</p>
                    <ul>
                        <li><strong>Value sliders</strong>: Set relative preference within a category (higher values = higher priority)</li>
                        <li><strong>Category weight</strong>: Controls the overall importance of this category in the final calculation</li>
                    </ul>
                    <p class="mb-0">Disable constraints to ignore them completely.</p>
                </div>
                
                <!-- Product Selection -->
                <div class="card mb-4 category-card {% if product_category_weight == 0 %}disabled{% endif %}" id="product_category_card">
                    <div class="card-header bg-success text-white position-relative">
                        <h5 class="mb-0"><i class="bi bi-basket"></i> Product Selection</h5>
                        <div class="form-check form-switch position-absolute" style="right: 10px; top: 10px;">
                            <input class="form-check-input category-toggle" type="checkbox" id="product_category_toggle" 
                                   data-category="product" {% if product_category_weight > 0 %}checked{% endif %}>
                            <label class="form-check-label text-white" for="product_category_toggle">Enable</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="product_category_weight" 
                                   name="category_weight" min="0" max="100" step="1" value="{{ product_category_weight * 100 }}"
                                   {% if product_category_weight == 0 %}disabled{% endif %}>
                            <span class="category-weight-value" id="product_weight_display">{{ "%.0f%%"|format(product_category_weight * 100) }}</span>
                        </div>
                        
                        <div class="row">
                            {% for product in products.itertuples() %}
                            <div class="col-md-4 mb-3">
                                <div class="card constraint-card product {% if not product.is_enabled %}disabled{% endif %}" data-id="{{ product.id }}">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ product.id }}" {% if product.is_enabled %}checked{% endif %}>
                                            <label class="form-check-label" for="enable_{{ product.id }}">
                                                <strong>{{ product.name }}</strong>
                                            </label>
                                        </div>
                                        
                                        <div class="constraint-value-container">
                                            <span class="constraint-value-label">Value:</span>
                                            <input type="range" class="form-range constraint-slider product-value-slider" 
                                                   id="value_{{ product.id }}" min="0" max="100" step="1" 
                                                   value="{{ product.value * 100 }}" {% if not product.is_enabled %}disabled{% endif %}>
                                            <span class="constraint-value-display">{{ "%.0f%%"|format(product.value * 100) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Time Selection -->
                <div class="card mb-4 category-card {% if time_category_weight == 0 %}disabled{% endif %}" id="time_category_card">
                    <div class="card-header bg-info text-white position-relative">
                        <h5 class="mb-0"><i class="bi bi-clock"></i> Time Selection</h5>
                        <div class="form-check form-switch position-absolute" style="right: 10px; top: 10px;">
                            <input class="form-check-input category-toggle" type="checkbox" id="time_category_toggle" 
                                   data-category="time" {% if time_category_weight > 0 %}checked{% endif %}>
                            <label class="form-check-label text-white" for="time_category_toggle">Enable</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="time_category_weight" 
                                   name="category_weight" min="0" max="100" step="1" value="{{ time_category_weight * 100 }}"
                                   {% if time_category_weight == 0 %}disabled{% endif %}>
                            <span class="category-weight-value" id="time_weight_display">{{ "%.0f%%"|format(time_category_weight * 100) }}</span>
                        </div>
                        
                        <div class="row">
                            {% for time in times.itertuples() %}
                            <div class="col-md-4 mb-3">
                                <div class="card constraint-card time {% if not time.is_enabled %}disabled{% endif %}" data-id="{{ time.id }}">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ time.id }}" {% if time.is_enabled %}checked{% endif %}>
                                            <label class="form-check-label" for="enable_{{ time.id }}">
                                                <strong>{{ time.name }}</strong>
                                            </label>
                                        </div>
                                        
                                        <div class="constraint-value-container">
                                            <span class="constraint-value-label">Value:</span>
                                            <input type="range" class="form-range constraint-slider time-value-slider" 
                                                   id="value_{{ time.id }}" min="0" max="100" step="1" 
                                                   value="{{ time.value * 100 }}" {% if not time.is_enabled %}disabled{% endif %}>
                                            <span class="constraint-value-display">{{ "%.0f%%"|format(time.value * 100) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Weighting Factors -->
                <div class="card mb-4 category-card {% if weighting_category_weight == 0 %}disabled{% endif %}" id="weighting_category_card">
                    <div class="card-header bg-warning text-dark position-relative">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Weighting Factors</h5>
                        <div class="form-check form-switch position-absolute" style="right: 10px; top: 10px;">
                            <input class="form-check-input category-toggle" type="checkbox" id="weighting_category_toggle" 
                                   data-category="weighting" {% if weighting_category_weight > 0 %}checked{% endif %}>
                            <label class="form-check-label text-dark" for="weighting_category_toggle">Enable</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="weighting_category_weight" 
                                   name="category_weight" min="0" max="100" step="1" value="{{ weighting_category_weight * 100 }}"
                                   {% if weighting_category_weight == 0 %}disabled{% endif %}>
                            <span class="category-weight-value" id="weighting_weight_display">{{ "%.0f%%"|format(weighting_category_weight * 100) }}</span>
                        </div>
                        
                        <div class="alert alert-info">
                            <p class="mb-0"><i class="bi bi-info-circle"></i> The values for Interest Rates and ECR Return are linked and will always sum to 1.0. Adjusting one will automatically update the other.</p>
                        </div>
                        <div class="row">
                            {% for weight in weightings.itertuples() %}
                            <div class="col-md-6 mb-3">
                                <div class="card constraint-card weight {% if not weight.is_enabled %}disabled{% endif %}" data-id="{{ weight.id }}">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ weight.id }}" {% if weight.is_enabled %}checked{% endif %}>
                                            <label class="form-check-label" for="enable_{{ weight.id }}">
                                                <strong>{{ weight.name }}</strong>
                                            </label>
                                        </div>
                                        
                                        <div class="constraint-value-container">
                                            <span class="constraint-value-label">Value:</span>
                                            <input type="range" class="form-range constraint-slider weighting-slider" 
                                                   id="value_{{ weight.id }}" 
                                                   min="0" 
                                                   max="100" 
                                                   step="1" 
                                                   value="{{ weight.value * 100 }}" 
                                                   data-weight-name="{{ weight.name }}"
                                                   {% if not weight.is_enabled %}disabled{% endif %}>
                                            <span class="constraint-value-display">{{ "%.0f%%"|format(weight.value * 100) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Bank Prioritization -->
                <div class="card mb-4 category-card {% if bank_category_weight == 0 %}disabled{% endif %}" id="bank_category_card">
                    <div class="card-header bg-secondary text-white position-relative">
                        <h5 class="mb-0"><i class="bi bi-bank"></i> Bank Prioritization</h5>
                        <div class="form-check form-switch position-absolute" style="right: 10px; top: 10px;">
                            <input class="form-check-input category-toggle" type="checkbox" id="bank_category_toggle" 
                                   data-category="bank" {% if bank_category_weight > 0 %}checked{% endif %}>
                            <label class="form-check-label text-white" for="bank_category_toggle">Enable</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="bank_category_weight" 
                                   name="category_weight" min="0" max="100" step="1" value="{{ bank_category_weight * 100 }}"
                                   {% if bank_category_weight == 0 %}disabled{% endif %}>
                            <span class="category-weight-value" id="bank_weight_display">{{ "%.0f%%"|format(bank_category_weight * 100) }}</span>
                        </div>
                        
                        <div class="row">
                            {% for bank in banks.itertuples() %}
                            <div class="col-md-4 mb-3">
                                <div class="card constraint-card bank {% if not bank.is_enabled %}disabled{% endif %}" data-id="{{ bank.id }}">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ bank.id }}" {% if bank.is_enabled %}checked{% endif %}>
                                            <label class="form-check-label" for="enable_{{ bank.id }}">
                                                <strong>{{ bank.name }}</strong>
                                            </label>
                                        </div>
                                        
                                        <div class="constraint-value-container">
                                            <span class="constraint-value-label">Value:</span>
                                            <input type="range" class="form-range constraint-slider bank-value-slider" 
                                                   id="value_{{ bank.id }}" min="0" max="100" step="1" 
                                                   value="{{ bank.value * 100 }}" {% if not bank.is_enabled %}disabled{% endif %}>
                                            <span class="constraint-value-display">{{ "%.0f%%"|format(bank.value * 100) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Liquidity Constraints -->
                <div class="card mb-4 category-card" id="liquidity_category_card">
                    <div class="card-header bg-info text-white position-relative">
                        <h5 class="mb-0"><i class="bi bi-droplet"></i> Liquidity Constraints</h5>
                        <div class="form-check form-switch position-absolute" style="right: 10px; top: 10px;">
                            <input class="form-check-input category-toggle" type="checkbox" id="liquidity_category_toggle" 
                                   data-category="liquidity" checked>
                            <label class="form-check-label text-white" for="liquidity_category_toggle">Enable</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Info Note -->
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i>
                            <strong>Note:</strong> Liquidity constraints only affect fund availability (reserve percentage), not the optimization scoring system.
                        </div>
                        
                        <div class="row">
                            {% for constraint in liquidity.itertuples() %}
                            <div class="col-md-6 mb-3">
                                <div class="card constraint-card liquidity {% if not constraint.is_enabled %}disabled{% endif %}" data-id="{{ constraint.id }}">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input constraint-toggle" type="checkbox" 
                                                   id="enable_{{ constraint.id }}" 
                                                   {% if constraint.is_enabled %}checked{% endif %}>
                                            <label class="form-check-label" for="enable_{{ constraint.id }}">
                                                <strong>{{ constraint.name }}</strong>
                                            </label>
                                        </div>
                                        
                                        <div class="constraint-value-container">
                                            <span class="constraint-value-label">Reserve Percentage:</span>
                                            <input type="range" class="form-range liquidity-slider" 
                                                   min="0" max="100" step="1" value="{{ constraint.value * 100 }}"
                                                   {% if not constraint.is_enabled %}disabled{% endif %}>
                                            <span class="constraint-value-display">{{ "%.0f%%"|format(constraint.value * 100) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Save All Changes -->
                <div class="card mt-4">
                    <div class="card-body text-center">
                        <button type="button" class="btn btn-primary btn-lg save-all-changes">
                            <i class="bi bi-save"></i> Save All Changes
                        </button>
                    </div>
                </div>

                <!-- Reset All Constraints -->
                <div class="card mt-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Reset All Constraints</h5>
                    </div>
                    <div class="card-body">
                        <p>This will reset all constraints to their default values.</p>
                        <button type="button" class="btn btn-danger category-reset-btn" data-category="all">
                            <i class="bi bi-arrow-repeat"></i> Reset All Constraints
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle category toggles with database synchronization
    const categoryToggles = document.querySelectorAll('.category-toggle');
    categoryToggles.forEach(toggle => {
        toggle.addEventListener('change', async function() {
            const category = this.dataset.category;
            const categoryCard = document.getElementById(`${category}_category_card`);
            const isEnabled = this.checked;
            
            // Special handling for liquidity constraints (no weight, only affects fund availability)
            if (category === 'liquidity') {
                try {
                    // Send AJAX request to update database
                    const response = await fetch('{{ url_for("admin_toggle_category") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `category=${category}&enabled=${isEnabled}`
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        if (isEnabled) {
                            // Enable the category
                            categoryCard.classList.remove('disabled');
                        } else {
                            // Disable the category
                            categoryCard.classList.add('disabled');
                        }
                    } else {
                        // Revert the toggle if database update failed
                        this.checked = !isEnabled;
                        console.error('Failed to update liquidity category:', result.message);
                    }
                } catch (error) {
                    // Revert the toggle if request failed
                    this.checked = !isEnabled;
                    console.error('Error updating liquidity category:', error);
                }
                return; // Exit early for liquidity constraints
            }
            
            // Handle other categories with weights
            const slider = document.getElementById(`${category}_category_weight`);
            const display = document.getElementById(`${category}_weight_display`);
            
            try {
                // Send AJAX request to update database
                const response = await fetch('{{ url_for("admin_toggle_category") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `category=${category}&enabled=${isEnabled}`
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (isEnabled) {
                        // Enable the category
                        categoryCard.classList.remove('disabled');
                        slider.disabled = false;
                        if (slider.value === '0') {
                            // Calculate default value based on other enabled sliders
                            const enabledSliders = getEnabledCategorySliders();
                            const totalValue = enabledSliders.reduce((sum, s) => sum + parseFloat(s.value), 0);
                            const defaultValue = Math.round((100 - totalValue) / (enabledSliders.length + 1));
                            slider.value = defaultValue;
                            display.textContent = defaultValue + '%';
                            // Redistribute other sliders
                            updateLinkedCategoryWeights();
                        }
                    } else {
                        // Disable the category
                        categoryCard.classList.add('disabled');
                        slider.disabled = true;
                        slider.value = '0';
                        display.textContent = '0%';
                        // Redistribute other sliders
                        updateLinkedCategoryWeights();
                    }
                } else {
                    // Revert the toggle if database update failed
                    this.checked = !isEnabled;
                    console.error('Failed to update category:', result.message);
                }
            } catch (error) {
                // Revert the toggle if request failed
                this.checked = !isEnabled;
                console.error('Error updating category:', error);
            }
        });
    });

    // Handle individual constraint toggles with database synchronization
    const constraintToggles = document.querySelectorAll('.constraint-toggle');
    constraintToggles.forEach(toggle => {
        toggle.addEventListener('change', async function() {
            const constraintCard = this.closest('.constraint-card');
            const valueSlider = constraintCard.querySelector('input[type="range"]');
            const valueDisplay = constraintCard.querySelector('.constraint-value-display');
            const constraintId = constraintCard.dataset.id;
            const isEnabled = this.checked;
            
            try {
                // Send AJAX request to update database
                const response = await fetch('{{ url_for("admin_update_constraint_individual") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `id=${constraintId}&is_enabled=${isEnabled}&value=${valueSlider ? valueSlider.value : 0}`
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (isEnabled) {
                        // Enable the constraint
                        constraintCard.classList.remove('disabled');
                        if (valueSlider) {
                            valueSlider.disabled = false;
                        }
                        
                        // Restore proportional values for linked sliders in this category
                        const category = constraintCard.className.split(' ').find(cls => 
                            ['product', 'time', 'bank', 'weighting'].includes(cls));
                        if (category) {
                            const sliderFunctions = getSliderFunctions(category);
                            if (sliderFunctions) {
                                sliderFunctions.restoreProportionalValue(valueSlider);
                            }
                        }
                    } else {
                        // Disable the constraint
                        constraintCard.classList.add('disabled');
                        if (valueSlider) {
                            valueSlider.disabled = true;
                        }
                        
                        // Redistribute values among remaining enabled sliders
                        const category = constraintCard.className.split(' ').find(cls => 
                            ['product', 'time', 'bank', 'weighting'].includes(cls));
                        if (category) {
                            const sliderFunctions = getSliderFunctions(category);
                            if (sliderFunctions) {
                                // Trigger redistribution by updating the first enabled slider
                                const enabledSliders = sliderFunctions.getEnabledSliders();
                                if (enabledSliders.length > 0) {
                                    sliderFunctions.updateLinkedValues(enabledSliders[0]);
                                }
                            }
                        }
                    }
                } else {
                    // Revert the toggle if database update failed
                    this.checked = !isEnabled;
                    console.error('Failed to update constraint:', result.message);
                }
            } catch (error) {
                // Revert the toggle if request failed
                this.checked = !isEnabled;
                console.error('Error updating constraint:', error);
            }
        });
    });

    // Function to get enabled category sliders (excluding liquidity)
    const getEnabledCategorySliders = () => {
        const categorySliders = document.querySelectorAll('.category-weight-slider');
        return Array.from(categorySliders).filter(slider => {
            const category = slider.id.split('_')[0];
            return category !== 'liquidity' && !slider.disabled;
        });
    };

    // Function to update linked category weights
    const updateLinkedCategoryWeights = () => {
        const enabledSliders = getEnabledCategorySliders();
        if (enabledSliders.length === 0) return;

        // Calculate total of all enabled sliders
        const total = enabledSliders.reduce((sum, slider) => sum + parseFloat(slider.value), 0);
        
        // If total is not 100, adjust values proportionally
        if (total !== 100) {
            enabledSliders.forEach(slider => {
                const currentValue = parseFloat(slider.value);
                let newValue;
                if (total === 0) {
                    // If total is 0, distribute evenly
                    newValue = Math.round(100 / enabledSliders.length);
                } else {
                    // Otherwise, adjust proportionally
                    newValue = Math.round((currentValue / total) * 100);
                }
                slider.value = newValue;
                
                // Update display
                const display = document.getElementById(slider.id.replace('category_weight', 'weight_display'));
                if (display) {
                    display.textContent = newValue + '%';
                }
            });
        }
    };

    // Add event listeners to category weight sliders (UI only, save on button click)
    const categoryWeightSliders = document.querySelectorAll('.category-weight-slider');
    categoryWeightSliders.forEach(slider => {
        slider.addEventListener('input', function() {
            const display = document.getElementById(this.id.replace('category_weight', 'weight_display'));
            if (display) {
                display.textContent = this.value + '%';
            }
            
            if (this.id.split('_')[0] !== 'liquidity') {  // Only link non-liquidity sliders
                updateLinkedCategoryWeights();
            }
        });
    });



    // Initialize category weights to ensure they sum to 100
    updateLinkedCategoryWeights();

    // Link value sliders within each category with dynamic 100% total behavior
    const linkCategoryValueSliders = (category) => {
        console.log(`Linking sliders for category: ${category}`);
        
        // Special handling for weighting category
        let sliders;
        if (category === 'weighting') {
            sliders = document.querySelectorAll('input[data-weight-name]');
            console.log(`Found ${sliders.length} weighting sliders by data-weight-name:`, Array.from(sliders).map(s => s.id));
        } else {
            sliders = document.querySelectorAll(`.${category}-value-slider`);
            console.log(`Found ${sliders.length} sliders for ${category}:`, Array.from(sliders).map(s => s.id));
        }
        
        // Function to get only enabled sliders in this category
        const getEnabledSliders = () => {
            return Array.from(sliders).filter(slider => {
                const constraintCard = slider.closest('.constraint-card');
                const toggle = constraintCard.querySelector('.constraint-toggle');
                return toggle && toggle.checked && !slider.disabled;
            });
        };
        
        // Function to update linked values maintaining 100% total
        const updateLinkedValues = (changedSlider) => {
            console.log('updateLinkedValues called for slider:', changedSlider.id);
            const enabledSliders = getEnabledSliders();
            console.log('Enabled sliders:', enabledSliders.length);
            if (enabledSliders.length <= 1) {
                console.log('Not enough enabled sliders, returning');
                return;
            }
            
            const changedValue = parseFloat(changedSlider.value);
            const otherSliders = enabledSliders.filter(s => s !== changedSlider);
            console.log('Other sliders to adjust:', otherSliders.length);
            
            if (otherSliders.length === 0) {
                console.log('No other sliders to adjust, returning');
                return;
            }
            
            // Calculate how much percentage is available for other sliders
            const remainingPercentage = 100 - changedValue;
            
            if (remainingPercentage < 0) {
                // If changed slider exceeds 100%, cap it and redistribute
                changedSlider.value = 100;
                changedSlider.parentElement.querySelector('.constraint-value-display').textContent = '100%';
                
                // Set all other sliders to 0
                otherSliders.forEach(slider => {
                    slider.value = 0;
                    const display = slider.parentElement.querySelector('.constraint-value-display');
                    if (display) {
                        display.textContent = '0%';
                    }
                });
                return;
            }
            
            // Calculate total of other sliders before adjustment
            const otherTotal = otherSliders.reduce((sum, slider) => sum + parseFloat(slider.value), 0);
            
            if (otherTotal > 0) {
                // Distribute remaining percentage proportionally among other sliders
                otherSliders.forEach(slider => {
                    const currentValue = parseFloat(slider.value);
                    const proportion = currentValue / otherTotal;
                    const newValue = Math.round(proportion * remainingPercentage);
                    slider.value = newValue;
                    
                    const display = slider.parentElement.querySelector('.constraint-value-display');
                    if (display) {
                        display.textContent = newValue + '%';
                    }
                });
            } else {
                // If other sliders are all 0, distribute remaining percentage evenly
                const evenDistribution = Math.round(remainingPercentage / otherSliders.length);
                otherSliders.forEach(slider => {
                    slider.value = evenDistribution;
                    const display = slider.parentElement.querySelector('.constraint-value-display');
                    if (display) {
                        display.textContent = evenDistribution + '%';
                    }
                });
            }
        };
        
        // Function to restore proportional value when a slider is re-enabled
        const restoreProportionalValue = (enabledSlider) => {
            const enabledSliders = getEnabledSliders();
            if (enabledSliders.length <= 1) return;
            
            // Calculate total of all enabled sliders
            const total = enabledSliders.reduce((sum, slider) => sum + parseFloat(slider.value), 0);
            
            if (total > 100) {
                // If total exceeds 100%, redistribute proportionally
                enabledSliders.forEach(slider => {
                    const currentValue = parseFloat(slider.value);
                    const proportion = currentValue / total;
                    const newValue = Math.round(proportion * 100);
                    slider.value = newValue;
                    
                    const display = slider.parentElement.querySelector('.constraint-value-display');
                    if (display) {
                        display.textContent = newValue + '%';
                    }
                });
            }
        };
        
        // Add event listeners to all sliders in this category
        sliders.forEach(slider => {
            console.log(`Adding event listener to slider: ${slider.id}`);
            slider.addEventListener('input', function() {
                console.log(`Slider ${this.id} changed to ${this.value}%`);
                const display = this.parentElement.querySelector('.constraint-value-display');
                if (display) {
                    display.textContent = this.value + '%';
                }
                
                // Update linked values to maintain 100% total
                console.log('Calling updateLinkedValues...');
                updateLinkedValues(this);
            });
        });
        
        // Return functions for external use
        return {
            updateLinkedValues,
            restoreProportionalValue,
            getEnabledSliders
        };
    };

    // Initialize and link subcategory sliders after DOM is ready
    const initializeAndLinkSliders = () => {
        console.log('Initializing and linking subcategory sliders...');
        
        // Link value sliders for each category and store the returned functions
        const productSliderFunctions = linkCategoryValueSliders('product');
        const timeSliderFunctions = linkCategoryValueSliders('time');
        const bankSliderFunctions = linkCategoryValueSliders('bank');
        const weightingSliderFunctions = linkCategoryValueSliders('weighting');
        
        console.log('Slider functions created:', {
            product: !!productSliderFunctions,
            time: !!timeSliderFunctions,
            bank: !!bankSliderFunctions,
            weighting: !!weightingSliderFunctions
        });
        
        // Function to get the appropriate slider functions for a category
        const getSliderFunctions = (category) => {
            switch(category) {
                case 'product': return productSliderFunctions;
                case 'time': return timeSliderFunctions;
                case 'bank': return bankSliderFunctions;
                case 'weighting': return weightingSliderFunctions;
                default: return null;
            }
        };
        
        // Initialize subcategory sliders to ensure they sum to 100% within each category
        const initializeSubcategorySliders = () => {
            console.log('Initializing subcategory sliders...');
            ['product', 'time', 'bank', 'weighting'].forEach(category => {
                console.log(`Initializing ${category} sliders...`);
                const sliderFunctions = getSliderFunctions(category);
                if (sliderFunctions) {
                    console.log(`Found functions for ${category}`);
                    const enabledSliders = sliderFunctions.getEnabledSliders();
                    console.log(`Enabled sliders for ${category}:`, enabledSliders.length);
                    if (enabledSliders.length > 0) {
                        // Ensure the first enabled slider triggers redistribution
                        sliderFunctions.updateLinkedValues(enabledSliders[0]);
                    }
                } else {
                    console.log(`No functions found for ${category}`);
                }
            });
        };
        
        // Initialize subcategory sliders
        initializeSubcategorySliders();
        

        
        // Make getSliderFunctions available globally for constraint toggle handlers
        window.getSliderFunctions = getSliderFunctions;
    };
    
    // Initialize and link sliders after a short delay to ensure DOM is ready
    setTimeout(initializeAndLinkSliders, 100);
    
    // Weighting sliders are now handled by the unified linking system
    // No separate initialization needed
    
    // Manual test function - call this in console to test slider linking
    window.testSliderLinking = () => {
        console.log('=== TESTING SLIDER LINKING ===');
        console.log('Product sliders:', document.querySelectorAll('.product-value-slider').length);
        console.log('Time sliders:', document.querySelectorAll('.time-value-slider').length);
        console.log('Bank sliders:', document.querySelectorAll('.bank-value-slider').length);
        
        const productSlider = document.querySelector('.product-value-slider');
        if (productSlider) {
            console.log('Testing product slider event...');
            productSlider.dispatchEvent(new Event('input'));
        }
        
        console.log('=== END TEST ===');
    };
    
    // Manual test function specifically for weighting sliders
    window.testWeightingSliders = () => {
        console.log('=== TESTING WEIGHTING SLIDERS ===');
        
        const weightingSliders = document.querySelectorAll('.weighting-slider');
        console.log('Weighting sliders found:', weightingSliders.length);
        
        if (weightingSliders.length >= 2) {
            const interestSlider = Array.from(weightingSliders).find(slider => 
                slider.getAttribute('data-weight-name') === 'Interest Rates');
            const ecrSlider = Array.from(weightingSliders).find(slider => 
                slider.getAttribute('data-weight-name') === 'ECR Return');
                
            if (interestSlider && ecrSlider) {
                console.log('Found both sliders, testing linking...');
                console.log('Current Interest value:', interestSlider.value + '%');
                console.log('Current ECR value:', ecrSlider.value + '%');
                
                // Test the linking
                interestSlider.dispatchEvent(new Event('input'));
                
                console.log('After test - Interest value:', interestSlider.value + '%');
                console.log('After test - ECR value:', ecrSlider.value + '%');
            } else {
                console.log('Could not find both sliders');
            }
        } else {
            console.log('Not enough weighting sliders found');
        }
        
        console.log('=== END WEIGHTING TEST ===');
    };
    
    // Simple test function for weighting sliders
    window.testWeightingLinking = () => {
        console.log('=== SIMPLE WEIGHTING TEST ===');
        if (window.interestSlider && window.ecrSlider) {
            console.log('Testing Interest slider change...');
            const oldInterest = window.interestSlider.value;
            const oldEcr = window.ecrSlider.value;
            
            // Change interest slider
            window.interestSlider.value = 50;
            window.interestSlider.dispatchEvent(new Event('input'));
            
            console.log('Interest changed from', oldInterest, 'to', window.interestSlider.value);
            console.log('ECR changed from', oldEcr, 'to', window.ecrSlider.value);
        } else {
            console.log('Weighting sliders not found in window object');
        }
        console.log('=== END SIMPLE TEST ===');
    };

    // Special handling for liquidity sliders (UI only, save on button click)
    const liquiditySliders = document.querySelectorAll('.liquidity-slider');
    liquiditySliders.forEach(slider => {
        slider.addEventListener('input', function() {
            const display = this.parentElement.querySelector('.constraint-value-display');
            if (display) {
                display.textContent = this.value + '%';
            }
        });
    });



    // Save all changes functionality - collect all current values and save them
    const saveAllButton = document.querySelector('.save-all-changes');
    saveAllButton.addEventListener('click', async function() {
        const originalText = this.innerHTML;
        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving Changes...';
        this.classList.remove('btn-primary');
        this.classList.add('btn-warning');
        
        try {
            // Collect all current constraint values
            const allUpdates = [];
            
            // Get all constraint toggles and values
            const constraintCards = document.querySelectorAll('.constraint-card');
            constraintCards.forEach(card => {
                const constraintId = card.dataset.id;
                const toggle = card.querySelector('.constraint-toggle');
                const valueSlider = card.querySelector('input[type="range"]');
                
                if (toggle && valueSlider) {
                    allUpdates.push({
                        id: constraintId,
                        is_enabled: toggle.checked,
                        value: valueSlider.value
                    });
                }
            });
            
            // Get all category weights
            const categorySliders = document.querySelectorAll('.category-weight-slider');
            const categoryUpdates = [];
            categorySliders.forEach(slider => {
                const category = slider.id.split('_')[0];
                const weight = parseFloat(slider.value) / 100;
                categoryUpdates.push({ category, weight });
            });
            
            // Update all constraints
            const constraintPromises = allUpdates.map(update => 
                fetch('{{ url_for("admin_update_constraint_individual") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `id=${update.id}&is_enabled=${update.is_enabled}&value=${update.value}`
                })
            );
            
            // Update all category weights
            const categoryPromises = categoryUpdates.map(update =>
                fetch('{{ url_for("admin_update_category_weight") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `category=${update.category}&weight=${update.weight}`
                })
            );
            
            // Wait for all updates to complete
            await Promise.all([...constraintPromises, ...categoryPromises]);
            
            // Show success
            this.innerHTML = '<i class="bi bi-check-circle"></i> All Changes Saved!';
            this.classList.remove('btn-warning');
            this.classList.add('btn-success');
            
            setTimeout(() => {
                this.innerHTML = originalText;
                this.classList.remove('btn-success');
                this.classList.add('btn-primary');
                this.disabled = false;
            }, 2000);
            
        } catch (error) {
            console.error('Error saving all changes:', error);
            
            // Show error
            this.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Save Failed!';
            this.classList.remove('btn-warning');
            this.classList.add('btn-danger');
            
            setTimeout(() => {
                this.innerHTML = originalText;
                this.classList.remove('btn-danger');
                this.classList.add('btn-primary');
                this.disabled = false;
            }, 3000);
        }
    });
});
</script>
{% endblock %} 