{% extends "base.html" %}

{% block title %}Optimization Constraints - Fund Allocation Optimizer{% endblock %}

{% block extra_css %}
<style>
    .constraint-slider {
        width: 100%;
    }
    .constraint-card {
        transition: all 0.3s ease;
    }
    .constraint-card.disabled {
        opacity: 0.6;
    }
    .reset-btn {
        position: absolute;
        right: 10px;
        top: 10px;
    }
    /* Added style for the special linked sliders */
    .linked-slider-container {
        position: relative;
    }
    .linked-slider-hint {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: -10px;
        margin-bottom: 10px;
    }
    .category-weight-container {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 5px;
    }
    .category-weight-label {
        margin-right: 15px;
        font-weight: bold;
        min-width: 130px;
    }
    .category-weight-slider {
        flex-grow: 1;
        margin-right: 10px;
    }
    .category-weight-value {
        min-width: 40px;
        text-align: center;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        {% include "admin/sidebar.html" %}
    </div>
    <div class="col-md-9">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-sliders"></i> Optimization Constraints</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> About Constraints</h5>
                    <p>Adjust the values below to control how the optimization algorithm allocates funds:</p>
                    <ul>
                        <li><strong>Value sliders</strong>: Set relative preference within a category (higher values = higher priority)</li>
                        <li><strong>Category weight</strong>: Controls the overall importance of this category in the final calculation</li>
                    </ul>
                    <p class="mb-0">Disable constraints to ignore them completely.</p>
                </div>
                
                <!-- Product Selection -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white position-relative">
                        <h5 class="mb-0"><i class="bi bi-basket"></i> Product Selection</h5>
                        <button type="button" class="btn btn-sm btn-outline-light reset-btn category-reset-btn" data-category="product">
                            <i class="bi bi-arrow-repeat"></i> Reset
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="product_category_weight" 
                                   name="category_weight" min="0" max="5" step="0.1" value="{{ product_category_weight }}">
                            <span class="category-weight-value" id="product_weight_display">{{ product_category_weight }}</span>
                            <button type="button" class="btn btn-sm btn-outline-success ms-2 update-category-weight-btn" 
                                    data-category="product">Update</button>
                        </div>
                        
                        <div class="row">
                            {% for product in products.itertuples() %}
                            <div class="col-md-4 mb-3">
                                <div class="card constraint-card product {% if not product.is_enabled %}disabled{% endif %}" data-id="{{ product.id }}">
                                    <div class="card-body">
                                        <form method="post" action="{{ url_for('admin_update_constraint') }}" onsubmit="return false;">
                                            <input type="hidden" name="id" value="{{ product.id }}">
                                            <input type="hidden" name="category" value="{{ product.category }}">
                                            
                                            <div class="form-check form-switch mb-2">
                                                <input type="hidden" name="is_enabled" value="0">
                                                <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ product.id }}" name="is_enabled" value="1" {% if product.is_enabled %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_{{ product.id }}">
                                                    <strong>{{ product.name }}</strong>
                                                </label>
                                            </div>
                                            
                                            <div class="mb-2">
                                                <label for="value_{{ product.id }}" class="form-label">Value: <span class="value-display">{{ product.value }}</span></label>
                                                <input type="range" class="form-range constraint-slider" id="value_{{ product.id }}" name="value" min="0" max="10" step="0.1" value="{{ product.value }}" {% if not product.is_enabled %}disabled{% endif %}>
                                            </div>
                                            
                                            <!-- Removed individual weight slider -->
                                            <input type="hidden" name="weight" value="{{ product_category_weight }}">
                                            
                                            <div class="d-grid">
                                                <button type="button" class="btn btn-sm btn-outline-success update-btn" {% if not product.is_enabled %}disabled{% endif %}>Update</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Time Selection -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white position-relative">
                        <h5 class="mb-0"><i class="bi bi-clock"></i> Time Selection</h5>
                        <button type="button" class="btn btn-sm btn-outline-light reset-btn category-reset-btn" data-category="time">
                            <i class="bi bi-arrow-repeat"></i> Reset
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="time_category_weight" 
                                   name="category_weight" min="0" max="5" step="0.1" value="{{ time_category_weight }}">
                            <span class="category-weight-value" id="time_weight_display">{{ time_category_weight }}</span>
                            <button type="button" class="btn btn-sm btn-outline-info ms-2 update-category-weight-btn" 
                                    data-category="time">Update</button>
                        </div>
                        
                        <div class="row">
                            {% for time in times.itertuples() %}
                            <div class="col-md-4 mb-3">
                                <div class="card constraint-card time {% if not time.is_enabled %}disabled{% endif %}" data-id="{{ time.id }}">
                                    <div class="card-body">
                                        <form method="post" action="{{ url_for('admin_update_constraint') }}" onsubmit="return false;">
                                            <input type="hidden" name="id" value="{{ time.id }}">
                                            <input type="hidden" name="category" value="{{ time.category }}">
                                            
                                            <div class="form-check form-switch mb-2">
                                                <input type="hidden" name="is_enabled" value="0">
                                                <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ time.id }}" name="is_enabled" value="1" {% if time.is_enabled %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_{{ time.id }}">
                                                    <strong>{{ time.name }}</strong>
                                                </label>
                                            </div>
                                            
                                            <div class="mb-2">
                                                <label for="value_{{ time.id }}" class="form-label">Value: <span class="value-display">{{ time.value }}</span></label>
                                                <input type="range" class="form-range constraint-slider" id="value_{{ time.id }}" name="value" min="0" max="10" step="0.1" value="{{ time.value }}" {% if not time.is_enabled %}disabled{% endif %}>
                                            </div>
                                            
                                            <!-- Removed individual weight slider -->
                                            <input type="hidden" name="weight" value="{{ time_category_weight }}">
                                            
                                            <div class="d-grid">
                                                <button type="button" class="btn btn-sm btn-outline-info update-btn" {% if not time.is_enabled %}disabled{% endif %}>Update</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Weighting Factors -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark position-relative">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Weighting Factors</h5>
                        <button type="button" class="btn btn-sm btn-outline-dark reset-btn category-reset-btn" data-category="weighting">
                            <i class="bi bi-arrow-repeat"></i> Reset
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="weighting_category_weight" 
                                   name="category_weight" min="0" max="5" step="0.1" value="{{ weighting_category_weight }}">
                            <span class="category-weight-value" id="weighting_weight_display">{{ weighting_category_weight }}</span>
                            <button type="button" class="btn btn-sm btn-outline-warning ms-2 update-category-weight-btn" 
                                    data-category="weighting">Update</button>
                        </div>
                        
                        <div class="alert alert-info">
                            <p class="mb-0"><i class="bi bi-info-circle"></i> The values for Interest Rates and ECR Return are linked and will always sum to 1.0. Adjusting one will automatically update the other.</p>
                        </div>
                        <div class="row">
                            {% for weight in weightings.itertuples() %}
                            <div class="col-md-6 mb-3">
                                <div class="card constraint-card weight {% if not weight.is_enabled %}disabled{% endif %}" data-id="{{ weight.id }}">
                                    <div class="card-body">
                                        <form method="post" action="{{ url_for('admin_update_constraint') }}" id="form_{{ weight.id }}" onsubmit="return false;">
                                            <input type="hidden" name="id" value="{{ weight.id }}">
                                            <input type="hidden" name="category" value="{{ weight.category }}">
                                            
                                            <div class="form-check form-switch mb-2">
                                                <input type="hidden" name="is_enabled" value="0">
                                                <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ weight.id }}" name="is_enabled" value="1" {% if weight.is_enabled %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_{{ weight.id }}">
                                                    <strong>{{ weight.name }}</strong>
                                                </label>
                                            </div>
                                            
                                            <div class="mb-2 linked-slider-container">
                                                <label for="value_{{ weight.id }}" class="form-label">Value (0-1): <span class="value-display">{{ weight.value }}</span></label>
                                                <input type="range" class="form-range constraint-slider weighting-slider" 
                                                       id="value_{{ weight.id }}" 
                                                       name="value" 
                                                       min="0" 
                                                       max="1" 
                                                       step="0.01" 
                                                       value="{{ weight.value }}" 
                                                       data-weight-name="{{ weight.name }}"
                                                       {% if not weight.is_enabled %}disabled{% endif %}>
                                                <div class="linked-slider-hint">Linked with other weighting factor</div>
                                            </div>
                                            
                                            <!-- Removed individual weight slider -->
                                            <input type="hidden" name="weight" value="{{ weighting_category_weight }}">
                                            
                                            <div class="d-grid">
                                                <button type="button" class="btn btn-sm btn-outline-warning update-btn" {% if not weight.is_enabled %}disabled{% endif %}>Update</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Bank Prioritization -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white position-relative">
                        <h5 class="mb-0"><i class="bi bi-bank"></i> Bank Prioritization</h5>
                        <button type="button" class="btn btn-sm btn-outline-light reset-btn category-reset-btn" data-category="bank">
                            <i class="bi bi-arrow-repeat"></i> Reset
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Category Weight Slider -->
                        <div class="category-weight-container">
                            <span class="category-weight-label">Category Weight:</span>
                            <input type="range" class="form-range category-weight-slider" id="bank_category_weight" 
                                   name="category_weight" min="0" max="5" step="0.1" value="{{ bank_category_weight }}">
                            <span class="category-weight-value" id="bank_weight_display">{{ bank_category_weight }}</span>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2 update-category-weight-btn" 
                                    data-category="bank">Update</button>
                        </div>
                        
                        <div class="row">
                            {% for bank in banks.itertuples() %}
                            <div class="col-md-4 mb-3">
                                <div class="card constraint-card bank {% if not bank.is_enabled %}disabled{% endif %}" data-id="{{ bank.id }}">
                                    <div class="card-body">
                                        <form method="post" action="{{ url_for('admin_update_constraint') }}" onsubmit="return false;">
                                            <input type="hidden" name="id" value="{{ bank.id }}">
                                            <input type="hidden" name="category" value="{{ bank.category }}">
                                            
                                            <div class="form-check form-switch mb-2">
                                                <input type="hidden" name="is_enabled" value="0">
                                                <input class="form-check-input constraint-toggle" type="checkbox" id="enable_{{ bank.id }}" name="is_enabled" value="1" {% if bank.is_enabled %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_{{ bank.id }}">
                                                    <strong>{{ bank.name }}</strong>
                                                </label>
                                            </div>
                                            
                                            <div class="mb-2">
                                                <label for="value_{{ bank.id }}" class="form-label">Value: <span class="value-display">{{ bank.value }}</span></label>
                                                <input type="range" class="form-range constraint-slider" id="value_{{ bank.id }}" name="value" min="0" max="10" step="0.1" value="{{ bank.value }}" {% if not bank.is_enabled %}disabled{% endif %}>
                                            </div>
                                            
                                            <!-- Removed individual weight slider -->
                                            <input type="hidden" name="weight" value="{{ bank_category_weight }}">
                                            
                                            <div class="d-grid">
                                                <button type="button" class="btn btn-sm btn-outline-secondary update-btn" {% if not bank.is_enabled %}disabled{% endif %}>Update</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Reset All Constraints -->
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Reset All Constraints</h5>
                    </div>
                    <div class="card-body">
                        <p>This will reset all constraints to their default values.</p>
                        <button type="button" class="btn btn-danger category-reset-btn" data-category="all">
                            <i class="bi bi-arrow-repeat"></i> Reset All Constraints
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update value displays when sliders change
    const valueSliders = document.querySelectorAll('input[name="value"]');
    valueSliders.forEach(slider => {
        const display = slider.parentElement.querySelector('.value-display');
        slider.addEventListener('input', function() {
            display.textContent = this.value;
        });
    });
    
    // Update category weight displays when category sliders change
    const categoryWeightSliders = document.querySelectorAll('.category-weight-slider');
    categoryWeightSliders.forEach(slider => {
        const display = document.getElementById(slider.id.replace('category_weight', 'weight_display'));
        slider.addEventListener('input', function() {
            // Update the display value immediately when slider moves
            if (display) {
                display.textContent = this.value;
            }
            
            // Update all hidden weight inputs in this category
            const categoryName = this.id.split('_')[0];
            const hiddenWeightInputs = document.querySelectorAll(`form[action*="admin_update_constraint"] input[name="weight"]`);
            hiddenWeightInputs.forEach(input => {
                const form = input.closest('form');
                const formCategory = form.querySelector('input[name="category"]').value;
                if (formCategory === categoryName) {
                    input.value = this.value;
                }
            });
        });
    });
    
    // Handle category weight update buttons
    const categoryWeightButtons = document.querySelectorAll('.update-category-weight-btn');
    categoryWeightButtons.forEach(button => {
        button.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            const weightValue = document.getElementById(category + '_category_weight').value;
            
            // Create and submit a form to update all weights in this category
            fetch('{{ url_for("admin_update_category_weight") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `category=${category}&weight=${weightValue}`
            })
            .then(response => {
                if (response.ok) {
                    // Show success feedback
                    const originalText = this.textContent;
                    const originalClasses = [...this.classList];
                    
                    this.textContent = '✓ Updated';
                    this.classList.add('btn-success');
                    this.classList.remove('btn-outline-success', 'btn-outline-info', 'btn-outline-warning', 'btn-outline-secondary');
                    
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.className = originalClasses.join(' '); // Restore all original classes
                    }, 1500);
                } else {
                    console.error('Update failed');
                    alert('Failed to update category weight. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating category weight. Please try again.');
            });
        });
    });
    
    // Handle all constraint form update buttons using event delegation
    document.addEventListener('click', function(e) {
        // Check if the clicked element is an update button
        if (e.target.classList.contains('update-btn')) {
            const button = e.target;
            const form = button.closest('form');
            const card = button.closest('.constraint-card');
            
            // Prevent default button behavior
            e.preventDefault();
            
            // Create form data from the form
            const formData = new FormData(form);
            
            // Submit the form data via fetch
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // On success, show a brief visual feedback
                    const originalText = button.textContent;
                    const originalClasses = [...button.classList];
                    
                    // Change button appearance to indicate success
                    button.textContent = '✓ Updated';
                    button.classList.add('btn-success');
                    button.classList.remove('btn-outline-success', 'btn-outline-info', 'btn-outline-warning', 'btn-outline-secondary');
                    
                    // Restore button after a delay
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = originalClasses.join(' '); // Restore all original classes
                    }, 1500);
                } else {
                    console.error('Update failed');
                    alert('Failed to update constraint. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating constraint. Please try again.');
            });
        }
    });
    
    // Handle toggle switches
    const toggles = document.querySelectorAll('.constraint-toggle');
    toggles.forEach(toggle => {
        // Get the original form and create a clone for toggle operations
        const originalForm = toggle.closest('form');
        const toggleForm = originalForm.cloneNode(true);
        toggleForm.style.display = 'none';
        document.body.appendChild(toggleForm);
        
        // Set up the toggle event handler
        toggle.addEventListener('change', function() {
            const card = this.closest('.constraint-card');
            const formControls = originalForm.querySelectorAll('input[type="range"], .update-btn');
            const isChecked = this.checked;
            
            // Update UI based on toggle state
            if (isChecked) {
                card.classList.remove('disabled');
                formControls.forEach(control => control.disabled = false);
            } else {
                card.classList.add('disabled');
                formControls.forEach(control => control.disabled = true);
            }
            
            // Prepare the toggle form submission
            const toggleFormCheckbox = toggleForm.querySelector('.constraint-toggle');
            toggleFormCheckbox.checked = isChecked;
            
            // Submit the toggle form
            fetch(toggleForm.action, {
                method: 'POST',
                body: new FormData(toggleForm)
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Toggle update failed');
                    // Revert UI on failure
                    this.checked = !isChecked;
                    if (!isChecked) {
                        card.classList.remove('disabled');
                        formControls.forEach(control => control.disabled = false);
                    } else {
                        card.classList.add('disabled');
                        formControls.forEach(control => control.disabled = true);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert UI on error
                this.checked = !isChecked;
                if (!isChecked) {
                    card.classList.remove('disabled');
                    formControls.forEach(control => control.disabled = false);
                } else {
                    card.classList.add('disabled');
                    formControls.forEach(control => control.disabled = true);
                }
            });
        });
    });
    
    // Special handling for weighting sliders to ensure they sum to 1.0
    const weightingSliders = document.querySelectorAll('.weighting-slider');
    
    if (weightingSliders.length === 2) {
        const interestSlider = Array.from(weightingSliders).find(slider => 
            slider.getAttribute('data-weight-name') === 'Interest Rates');
        const ecrSlider = Array.from(weightingSliders).find(slider => 
            slider.getAttribute('data-weight-name') === 'ECR Return');
            
        if (interestSlider && ecrSlider) {
            const updateLinkedSlider = (primarySlider, secondarySlider) => {
                const primaryValue = parseFloat(primarySlider.value);
                const newSecondaryValue = Math.round((1 - primaryValue) * 100) / 100; // Round to 2 decimal places
                
                secondarySlider.value = newSecondaryValue;
                // Make sure to update the displayed value in the UI
                const displayElement = secondarySlider.parentElement.querySelector('.value-display');
                if (displayElement) {
                    displayElement.textContent = newSecondaryValue;
                }
            };
            
            interestSlider.addEventListener('input', function() {
                updateLinkedSlider(this, ecrSlider);
            });
            
            ecrSlider.addEventListener('input', function() {
                updateLinkedSlider(this, interestSlider);
            });
            
            // Add click handlers to update buttons to ensure linked values are updated
            const interestForm = interestSlider.closest('form');
            const ecrForm = ecrSlider.closest('form');
            const interestBtn = interestForm.querySelector('.update-btn');
            const ecrBtn = ecrForm.querySelector('.update-btn');
            
            // When interest rate form is submitted, include ECR value
            interestForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Add ECR value as hidden field
                const hiddenECRInput = document.createElement('input');
                hiddenECRInput.type = 'hidden';
                hiddenECRInput.name = 'other_value';
                hiddenECRInput.value = ecrSlider.value;
                
                // Append to form and submit
                this.appendChild(hiddenECRInput);
                
                // Create and submit form data
                const formData = new FormData(this);
                fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // Success feedback
                        interestBtn.textContent = '✓ Updated';
                        interestBtn.classList.add('btn-success');
                        interestBtn.classList.remove('btn-outline-warning');
                        
                        setTimeout(() => {
                            interestBtn.textContent = 'Update';
                            interestBtn.classList.remove('btn-success');
                            interestBtn.classList.add('btn-outline-warning');
                        }, 1500);
                    } else {
                        alert('Failed to update constraint');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Error updating constraint');
                });
            });
            
            // When ECR form is submitted, include interest rate value
            ecrForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Add interest value as hidden field
                const hiddenInterestInput = document.createElement('input');
                hiddenInterestInput.type = 'hidden';
                hiddenInterestInput.name = 'other_value';
                hiddenInterestInput.value = interestSlider.value;
                
                // Append to form and submit
                this.appendChild(hiddenInterestInput);
                
                // Create and submit form data
                const formData = new FormData(this);
                fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // Success feedback
                        ecrBtn.textContent = '✓ Updated';
                        ecrBtn.classList.add('btn-success');
                        ecrBtn.classList.remove('btn-outline-warning');
                        
                        setTimeout(() => {
                            ecrBtn.textContent = 'Update';
                            ecrBtn.classList.remove('btn-success');
                            ecrBtn.classList.add('btn-outline-warning');
                        }, 1500);
                    } else {
                        alert('Failed to update constraint');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Error updating constraint');
                });
            });
        }
    }
});

// Handle category reset buttons
const categoryResetButtons = document.querySelectorAll('.category-reset-btn');
categoryResetButtons.forEach(button => {
    button.addEventListener('click', function() {
        const category = this.getAttribute('data-category');
        
        // Ask for confirmation before reset
        const confirmMessage = category === 'all' 
            ? 'Are you sure you want to reset ALL constraints to default values?' 
            : `Reset all ${category} constraints to default values?`;
            
        if (!confirm(confirmMessage)) {
            return;
        }
        
        // Show loading state on button
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Resetting...';
        this.disabled = true;
        
        // Make AJAX request to reset endpoint
        fetch('{{ url_for("admin_reset_constraints_ajax") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `category=${category}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success feedback
                this.innerHTML = '<i class="bi bi-check-circle"></i> Reset Complete';
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.disabled = false;
                }, 1500);
                
                // Update the UI with the new values
                updateUIAfterReset(category, data.data);
            } else {
                // Show error and reset button
                alert(`Error: ${data.message}`);
                this.innerHTML = originalText;
                this.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error resetting constraints. Please try again.');
            this.innerHTML = originalText;
            this.disabled = false;
        });
    });
});

// Function to update UI after reset
function updateUIAfterReset(category, data) {
    // Update category weight slider
    if (data.category_weights && category in data.category_weights) {
        const weightValue = data.category_weights[category];
        const categoryWeightSlider = document.getElementById(`${category}_category_weight`);
        const weightDisplay = document.getElementById(`${category}_weight_display`);
        
        if (categoryWeightSlider && weightDisplay) {
            categoryWeightSlider.value = weightValue;
            weightDisplay.textContent = weightValue;
        }
    }
    
    // Update constraint values and toggle states
    if (data.constraints) {
        data.constraints.forEach(constraint => {
            // Find the corresponding UI elements
            const constraintCard = document.querySelector(`.constraint-card[data-id="${constraint.id}"]`);
            if (constraintCard) {
                // Update value slider
                const valueSlider = constraintCard.querySelector('input[name="value"]');
                const valueDisplay = constraintCard.querySelector('.value-display');
                if (valueSlider && valueDisplay) {
                    valueSlider.value = constraint.value;
                    valueDisplay.textContent = constraint.value;
                }
                
                // Update toggle state
                const toggle = constraintCard.querySelector('.constraint-toggle');
                if (toggle) {
                    const wasEnabled = toggle.checked;
                    toggle.checked = constraint.is_enabled;
                    
                    // Update UI if toggle state changed
                    if (wasEnabled !== constraint.is_enabled) {
                        const formControls = constraintCard.querySelectorAll('input[type="range"], .update-btn');
                        if (constraint.is_enabled) {
                            constraintCard.classList.remove('disabled');
                            formControls.forEach(control => control.disabled = false);
                        } else {
                            constraintCard.classList.add('disabled');
                            formControls.forEach(control => control.disabled = true);
                        }
                    }
                }
                
                // Update weight value
                const weightInput = constraintCard.querySelector('input[name="weight"]');
                if (weightInput) {
                    weightInput.value = constraint.weight;
                }
            }
        });
        
        // Handle special case for weighting constraints (Interest Rates & ECR Return)
        if (category === 'weighting' || category === 'all') {
            const weightingSliders = document.querySelectorAll('.weighting-slider');
            if (weightingSliders.length === 2) {
                const interestSlider = Array.from(weightingSliders).find(slider => 
                    slider.getAttribute('data-weight-name') === 'Interest Rates');
                const ecrSlider = Array.from(weightingSliders).find(slider => 
                    slider.getAttribute('data-weight-name') === 'ECR Return');
                
                if (interestSlider && ecrSlider) {
                    // Make sure the displayed values are updated
                    const interestDisplay = interestSlider.parentElement.querySelector('.value-display');
                    const ecrDisplay = ecrSlider.parentElement.querySelector('.value-display');
                    
                    if (interestDisplay) {
                        interestDisplay.textContent = interestSlider.value;
                    }
                    
                    if (ecrDisplay) {
                        ecrDisplay.textContent = ecrSlider.value;
                    }
                }
            }
        }
    }
}
</script>
{% endblock %} 