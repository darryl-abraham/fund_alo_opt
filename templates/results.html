{% extends "base.html" %}

{% block title %}Optimization Results - Fund Allocation Optimizer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="bi bi-check-circle"></i> Optimization Results</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <p class="mb-0"><strong>Success!</strong> Your fund allocation has been optimized for maximum interest returns.</p>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5>Your Optimization Parameters</h5>
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <th style="width: 30%;">Branch Name</th>
                                    <td>{{ params.branch_name }}</td>
                                </tr>
                                <tr>
                                    <th>Bank Relationships</th>
                                    <td>
                                        {% if related_banks %}
                                            {% for bank in related_banks %}
                                                <span class="badge bg-primary me-1">{{ bank }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">No bank relationships found</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Association Name</th>
                                    <td>{{ params.association_name }}</td>
                                </tr>
                                <tr>
                                    <th>Total Association Funds</th>
                                    <td>${{ '{:,.2f}'.format(results.summary.total_funds) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Fund Allocation Adjustment Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-sliders"></i> Fund Allocation Adjustment</h5>
                            </div>
                            <div class="card-body">
                                <form id="reoptimizeForm" action="{{ url_for('reoptimize') }}" method="POST">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="text" 
                                                       class="form-control" 
                                                       id="allocationInput" 
                                                       name="allocation_amount" 
                                                       value="{{ '{:,.0f}'.format(results.summary.total_allocated) }}"
                                                       data-max="{{ results.summary.total_funds }}">
                                            </div>
                                            <div class="form-text">Available: ${{ '{:,.2f}'.format(results.summary.total_funds) }}</div>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-arrow-repeat"></i> Reoptimize with New Amount
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of Fund Allocation Adjustment Section -->
                
                <!-- Account Overview Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5 class="mb-3">Account Overview</h5>
                        <div class="card border-primary">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 border-end">
                                        <h6 class="text-primary mb-3">Initial Account Balance</h6>
                                        <h3 class="text-dark mb-2" id="initialBalance" data-total-funds="{{ results.summary.total_funds }}">${{ '{:,.2f}'.format(results.summary.total_funds) }}</h3>
                                        <p class="text-muted mb-0">Available for Investment</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-3">Current Investment Status</h6>
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="text-center flex-grow-1">
                                                <h3 class="text-dark mb-2" id="allocatedAmount">${{ '{:,.2f}'.format(results.summary.total_allocated) }}</h3>
                                                <p class="text-muted mb-0">Allocated for Investment</p>
                                            </div>
                                            <div class="border-start ps-4 text-center flex-grow-1">
                                                <h3 class="text-dark mb-2" id="remainingBalance">${{ '{:,.2f}'.format(results.summary.total_funds - results.summary.total_allocated) }}</h3>
                                                <p class="text-muted mb-0">Remaining Balance</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of Account Overview Section -->
                
                <!-- Current Portfolio Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5 class="mb-3">Current Portfolio</h5>
                        <div class="card border-info">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered">
                                        <thead class="table-info">
                                            <tr>
                                                <th>Bank/Holder</th>
                                                <th>Product Type</th>
                                                <th>Amount</th>
                                                <th>Rate (%)</th>
                                                <th>Monthly Interest</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in results.current_portfolio %}
                                            <tr>
                                                <td>{{ item.bank }}</td>
                                                <td>{{ item.product_type }}</td>
                                                <td>${{ '{:,.2f}'.format(item.amount) }}</td>
                                                <td>{{ '{:.3f}'.format(item.rate) }}</td>
                                                <td>${{ '{:.2f}'.format(item.monthly_interest) }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot class="table-info">
                                            <tr>
                                                <th colspan="2">TOTAL</th>
                                                <th>${{ '{:,.2f}'.format(results.current_portfolio_summary.total_balance) }}</th>
                                                <th>{{ '{:.3f}'.format(results.current_portfolio_summary.monthly_interest * 1200 / results.current_portfolio_summary.total_balance) if results.current_portfolio_summary.total_balance > 0 else '0.000' }}</th>
                                                <th>${{ '{:.2f}'.format(results.current_portfolio_summary.monthly_interest) }}</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of Current Portfolio Section -->
                
                <!-- Allocation Summary Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Allocation Summary</h5>
                            <a href="{{ url_for('download_results') }}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-download"></i> Download Excel
                            </a>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted">Total Allocated</h6>
                                        <h4 class="card-text" id="summaryTotalAllocated">${{ '{:,.2f}'.format(results.summary.total_allocated) }}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted">Expected Return</h6>
                                        <h4 class="card-text" id="summaryExpectedReturn">${{ '{:,.2f}'.format(results.summary.total_return) }}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted">Weighted Avg. Rate</h6>
                                        <h4 class="card-text" id="summaryAvgRate">{{ '{:.2f}'.format(results.summary.weighted_avg_rate) }}%</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted">Monthly ECR Benefit</h6>
                                        <h4 class="card-text" id="summaryECR">${{ '{:,.2f}'.format(results.summary.optimized_ecr_monthly) }}</h4>
                                        <small class="text-muted">Gain: ${{ '{:,.2f}'.format(results.summary.ecr_gain) }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of Allocation Summary Section -->
                
                <!-- Detailed Allocation Section -->
                <div class="row">
                    <div class="col-md-12">
                        <h5>Detailed Allocation</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Bank Name</th>
                                        <th>CD Term</th>
                                        <th>Allocated Amount</th>
                                        <th>CD Rate (%)</th>
                                        <th>Expected Return</th>
                                        <th>ECR Rate (%)</th>
                                        <th>ECR Monthly</th>
                                    </tr>
                                </thead>
                                <tbody id="allocationTableBody">
                                    {% for item in results.results %}
                                    <tr>
                                        <td>{{ item['Bank Name'] }}</td>
                                        <td>{{ item['CD Term'] }}</td>
                                        <td>${{ '{:,.2f}'.format(item['Allocated Amount']) }}</td>
                                        <td>{{ '{:.2f}'.format(item['CD Rate']) }}</td>
                                        <td>${{ '{:,.2f}'.format(item['Expected Return']) }}</td>
                                        <td>{{ '{:.2f}'.format(item['ECR Rate']) }}</td>
                                        <td>${{ '{:,.2f}'.format(item['Estimated ECR Monthly']) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-success">
                                    <tr>
                                        <th>TOTAL</th>
                                        <th></th>
                                        <th id="tableTotalAllocated">${{ '{:,.2f}'.format(results.summary.total_allocated) }}</th>
                                        <th id="tableAvgRate">{{ '{:.2f}'.format(results.summary.weighted_avg_rate) }}</th>
                                        <th id="tableTotalReturn">${{ '{:,.2f}'.format(results.summary.total_return) }}</th>
                                        <th></th>
                                        <th id="tableTotalECR">${{ '{:,.2f}'.format(results.summary.optimized_ecr_monthly) }}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- End of Detailed Allocation Section -->
                
                <div class="d-flex justify-content-between mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Form
                    </a>
                    <div>
                        <button type="button" class="btn btn-success me-2" id="sendProposalBtn">
                            <i class="bi bi-envelope"></i> Send Proposal
                        </button>
                        <a href="{{ url_for('clear_session') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Start New Optimization
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Visualization</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="allocationPieChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="termsBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Proposal Modal -->
<div class="modal fade" id="proposalModal" tabindex="-1" aria-labelledby="proposalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="proposalModalLabel">
                    <i class="bi bi-envelope"></i> Send Investment Proposal
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="proposalForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="recipientEmail" class="form-label">Recipient Email</label>
                            <input type="email" class="form-control" id="recipientEmail" name="recipientEmail" 
                                   placeholder="community.manager@example.com" required>
                        </div>
                        <div class="col-md-6">
                            <label for="subjectLine" class="form-label">Subject Line</label>
                            <input type="text" class="form-control" id="subjectLine" name="subjectLine" 
                                   value="Investment Proposal - {{ params.branch_name }} - {{ params.association_name }}" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailBody" class="form-label">Email Body</label>
                        <textarea class="form-control" id="emailBody" name="emailBody" rows="15" required></textarea>
                        <div class="form-text">Review and edit the proposal content before sending.</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Proposal Summary</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Total Allocated:</strong><br>
                                <span class="text-primary">${{ '{:,.2f}'.format(results.summary.total_allocated) }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Expected Return:</strong><br>
                                <span class="text-success">${{ '{:,.2f}'.format(results.summary.total_return) }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Weighted Avg. Rate:</strong><br>
                                <span class="text-info">{{ '{:.2f}'.format(results.summary.weighted_avg_rate) }}%</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Partner Banks:</strong><br>
                                <span class="text-secondary">{{ results.results|length }}</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendProposal()">
                    <i class="bi bi-send"></i> Send Proposal
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .table-responsive {
        overflow-x: auto;
    }
    canvas {
        max-width: 100%;
        height: auto;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Format number as currency
function formatCurrency(num) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2
    }).format(num);
}

// Format number as percentage
function formatRate(rate) {
    return rate.toFixed(2) + '%';
}

// Initialize data from template
const templateData = {
    allocationData: JSON.parse('{{ results.results|tojson|safe }}'),
    totalAllocated: Number('{{ results.summary.total_allocated|safe }}')
};

console.log('templateData initialized:', templateData);

// Global variables to store chart instances
let pieChart = null;
let barChart = null;

document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for the Send Proposal button
    const sendProposalBtn = document.getElementById('sendProposalBtn');
    if (sendProposalBtn) {
        sendProposalBtn.addEventListener('click', function() {
            console.log('Send Proposal button clicked');
            openProposalModal();
        });
    } else {
        console.error('Send Proposal button not found');
    }
    
    // Prepare data for allocation pie chart
    const bankData = {};
    templateData.allocationData.forEach(item => {
        const bankName = item['Bank Name'];
        if (!bankData[bankName]) {
            bankData[bankName] = 0;
        }
        bankData[bankName] += item['Allocated Amount'];
    });
    
    const bankNames = Object.keys(bankData);
    const bankAllocations = Object.values(bankData);
    
    // Generate random colors for pie chart
    const generateColors = (count) => {
        const colors = [];
        for (let i = 0; i < count; i++) {
            const hue = (i * 137) % 360;
            colors.push(`hsl(${hue}, 70%, 60%)`);
        }
        return colors;
    };
    
    // Create pie chart
    const pieCtx = document.getElementById('allocationPieChart').getContext('2d');
    pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: bankNames,
            datasets: [{
                data: bankAllocations,
                backgroundColor: generateColors(bankNames.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right'
                },
                title: {
                    display: true,
                    text: 'Allocation by Bank'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const percentage = ((value / templateData.totalAllocated) * 100).toFixed(1);
                            return `$${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Prepare data for terms bar chart
    const termData = {};
    templateData.allocationData.forEach(item => {
        const term = item['CD Term'];
        if (!termData[term]) {
            termData[term] = 0;
        }
        termData[term] += item['Allocated Amount'];
    });
    
    const terms = Object.keys(termData);
    const termAllocations = Object.values(termData);
    
    // Create bar chart
    const barCtx = document.getElementById('termsBarChart').getContext('2d');
    barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: terms,
            datasets: [{
                label: 'Allocation Amount',
                data: termAllocations,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Allocation by CD Term'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            return `$${value.toLocaleString()}`;
                        }
                    }
                }
            }
        }
    });
});

// Function to update charts with new data
function updateCharts(newAllocation) {
    if (!pieChart || !barChart) {
        console.error('Charts not initialized');
        return;
    }
    
    const ratio = newAllocation / templateData.totalAllocated;
    
    // Update pie chart data
    const newBankData = {};
    templateData.allocationData.forEach(item => {
        const bankName = item['Bank Name'];
        if (!newBankData[bankName]) {
            newBankData[bankName] = 0;
        }
        newBankData[bankName] += item['Allocated Amount'] * ratio;
    });
    
    pieChart.data.datasets[0].data = Object.values(newBankData);
    pieChart.update();

    // Update bar chart data
    const newTermData = {};
    templateData.allocationData.forEach(item => {
        const term = item['CD Term'];
        if (!newTermData[term]) {
            newTermData[term] = 0;
        }
        newTermData[term] += item['Allocated Amount'] * ratio;
    });
    
    barChart.data.datasets[0].data = Object.values(newTermData);
    barChart.update();
}
</script>

<script>
// Allocation adjustment functionality
document.addEventListener('DOMContentLoaded', function() {
    const allocationInput = document.getElementById('allocationInput');
    const maxAmount = parseFloat(allocationInput.dataset.max);
    const totalFunds = parseFloat(document.getElementById('initialBalance').dataset.totalFunds);

    // Format number with commas and no decimal places
    function formatNumber(num) {
        return new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(Math.round(num));
    }

    // Parse number string removing commas
    function parseFormattedNumber(str) {
        return parseFloat(str.replace(/,/g, ''));
    }

    // Format initial value
    allocationInput.value = formatNumber(parseFormattedNumber(allocationInput.value));

    allocationInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^\d,]/g, '');
        let number = parseFormattedNumber(value);
        
        if (!isNaN(number)) {
            if (number < 0) {
                number = 0;
            }
            e.target.value = formatNumber(number);
        }
    });

    // Handle form submission
    document.getElementById('reoptimizeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const allocationValue = parseFormattedNumber(allocationInput.value);
        
        if (allocationValue <= 0) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <strong>Error!</strong> Please enter a number greater than 0.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            this.parentElement.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
            return;
        }
        
        formData.set('allocation_amount', allocationValue);
        
        // Show loading state
        const submitButton = this.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Reoptimizing...';
        
        // Send AJAX request
        fetch('{{ url_for("reoptimize") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update Account Overview
                document.getElementById('allocatedAmount').textContent = '$' + formatNumber(data.summary.total_allocated);
                document.getElementById('remainingBalance').textContent = '$' + formatNumber(totalFunds - data.summary.total_allocated);
                
                // Update Allocation Summary
                document.getElementById('summaryTotalAllocated').textContent = '$' + formatNumber(data.summary.total_allocated);
                document.getElementById('summaryExpectedReturn').textContent = '$' + formatNumber(data.summary.total_return);
                document.getElementById('summaryAvgRate').textContent = data.summary.weighted_avg_rate.toFixed(2) + '%';
                document.getElementById('summaryECR').textContent = '$' + formatNumber(data.summary.optimized_ecr_monthly);
                document.getElementById('summaryECR').nextElementSibling.textContent = 'Gain: $' + formatNumber(data.summary.ecr_gain);
                
                // Update Detailed Allocation Table
                const tableBody = document.getElementById('allocationTableBody');
                tableBody.innerHTML = '';
                
                // Update templateData with new allocations
                templateData.allocationData = data.allocations;
                templateData.totalAllocated = data.summary.total_allocated;
                
                data.allocations.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item['Bank Name']}</td>
                        <td>${item['CD Term']}</td>
                        <td>${formatCurrency(item['Allocated Amount'])}</td>
                        <td>${formatRate(item['CD Rate'])}</td>
                        <td>${formatCurrency(item['Expected Return'])}</td>
                        <td>${formatRate(item['ECR Rate'])}</td>
                        <td>${formatCurrency(item['Estimated ECR Monthly'])}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Update table totals
                document.getElementById('tableTotalAllocated').textContent = formatCurrency(data.summary.total_allocated);
                document.getElementById('tableAvgRate').textContent = formatRate(data.summary.weighted_avg_rate);
                document.getElementById('tableTotalReturn').textContent = formatCurrency(data.summary.total_return);
                document.getElementById('tableTotalECR').textContent = formatCurrency(data.summary.optimized_ecr_monthly);
                
                // Update charts with new data
                updateCharts(data.summary.total_allocated);
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <strong>Success!</strong> Optimization completed with new allocation amount.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                this.parentElement.appendChild(alertDiv);
                
                // Remove alert after 5 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            } else {
                // Show error message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <strong>Error!</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                this.parentElement.appendChild(alertDiv);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <strong>Error!</strong> ${error.message || 'An unexpected error occurred. Please try again.'}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            this.parentElement.appendChild(alertDiv);
        })
        .finally(() => {
            // Restore button state
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        });
    });
});
</script>

<script>
// Proposal functionality
function openProposalModal() {
    console.log('openProposalModal called');
    console.log('templateData:', templateData);
    
    try {
        // Populate the email body with the proposal template
        const emailBody = generateProposalTemplate();
        console.log('Generated email body:', emailBody);
        
        document.getElementById('emailBody').value = emailBody;
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('proposalModal'));
        modal.show();
    } catch (error) {
        console.error('Error in openProposalModal:', error);
        alert('Error opening proposal modal: ' + error.message);
    }
}

function generateProposalTemplate() {
    // Get data from the existing templateData variable that's already defined
    const results = templateData.allocationData;
    const summary = {
        total_allocated: templateData.totalAllocated,
        total_return: parseFloat(document.getElementById('summaryExpectedReturn').textContent.replace('$', '').replace(',', '')),
        weighted_avg_rate: parseFloat(document.getElementById('summaryAvgRate').textContent.replace('%', ''))
    };
    
    // Get current portfolio data for comparison
    const currentPortfolioTable = document.querySelector('.table-info tbody');
    let currentTotalBalance = 0;
    let currentMonthlyInterest = 0;
    
    if (currentPortfolioTable) {
        const currentRows = currentPortfolioTable.querySelectorAll('tr');
        currentRows.forEach(row => {
            const amountCell = row.querySelector('td:nth-child(3)');
            const interestCell = row.querySelector('td:nth-child(5)');
            if (amountCell && interestCell) {
                const amount = parseFloat(amountCell.textContent.replace('$', '').replace(',', ''));
                const interest = parseFloat(interestCell.textContent.replace('$', '').replace(',', ''));
                if (!isNaN(amount)) currentTotalBalance += amount;
                if (!isNaN(interest)) currentMonthlyInterest += interest;
            }
        });
    }
    
    // Calculate current annual return (monthly * 12)
    const currentAnnualReturn = currentMonthlyInterest * 12;
    
    // Calculate deltas
    const returnDelta = summary.total_return - currentAnnualReturn;
    const returnDeltaPercent = currentAnnualReturn > 0 ? ((returnDelta / currentAnnualReturn) * 100) : 0;
    
    // Get params from the page content - using the table data that's already displayed
    const branchName = document.querySelector('table tbody tr:first-child td:last-child').textContent.trim();
    const associationName = document.querySelector('table tbody tr:last-child td:last-child').textContent.trim();
    
    let template = `Dear Community Manager,

I hope this email finds you well. I am writing to present an investment proposal for the ${associationName} association, optimized for the ${branchName} branch.

PROPOSAL SUMMARY:
• Total Investment Amount: $${summary.total_allocated.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
• Expected Annual Return: $${summary.total_return.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
• Weighted Average Interest Rate: ${summary.weighted_avg_rate.toFixed(2)}%
• Number of Partner Banks: ${results.length}

CURRENT vs. OPTIMIZED COMPARISON:
• Current Portfolio Balance: $${currentTotalBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
• Current Annual Return: $${currentAnnualReturn.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
• Optimized Annual Return: $${summary.total_return.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
• IMPROVEMENT: +$${returnDelta.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${returnDeltaPercent > 0 ? '+' : ''}${returnDeltaPercent.toFixed(1)}%)

DETAILED ALLOCATION BREAKDOWN:

`;
    
    // Add allocation details (excluding ECR rate and ECR Monthly)
    results.forEach((item, index) => {
        template += `${index + 1}. ${item['Bank Name']}
   • CD Term: ${item['CD Term']}
   • Allocated Amount: $${item['Allocated Amount'].toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
   • CD Rate: ${item['CD Rate'].toFixed(2)}%
   • Expected Return: $${item['Expected Return'].toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}

`;
    });
    
    template += `KEY HIGHLIGHTS:
• This allocation strategy maximizes interest returns while maintaining appropriate diversification across partner banks
• The weighted average rate of ${summary.weighted_avg_rate.toFixed(2)}% provides competitive returns in the current market environment
• Funds are strategically distributed across different CD terms to balance liquidity needs with return optimization
• The optimization delivers a ${returnDeltaPercent > 0 ? 'significant improvement' : 'improvement'} of $${returnDelta.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} in annual returns compared to your current portfolio

NEXT STEPS:
Please review this proposal and let me know if you have any questions or if you'd like to discuss any modifications to the allocation strategy.

I'm available for a call or meeting to discuss this proposal in detail.

Best regards,
[Your Name]
[Your Title]
[Contact Information]`;
    
    return template;
}

function sendProposal() {
    const form = document.getElementById('proposalForm');
    const formData = new FormData(form);
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Show loading state
    const sendButton = document.querySelector('#proposalModal .btn-primary');
    const originalText = sendButton.innerHTML;
    sendButton.disabled = true;
    sendButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
    
    // Send the proposal data to the backend
    fetch('{{ url_for("send_proposal") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <strong>Success!</strong> ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('#proposalModal .modal-body').insertBefore(alertDiv, form);
            
            // Close modal after 3 seconds
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('proposalModal'));
                modal.hide();
            }, 3000);
        } else {
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <strong>Error!</strong> ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('#proposalModal .modal-body').insertBefore(alertDiv, form);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Show error message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            <strong>Error!</strong> An unexpected error occurred. Please try again.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('#proposalModal .modal-body').insertBefore(alertDiv, form);
    })
    .finally(() => {
        // Restore button state
        sendButton.disabled = false;
        sendButton.innerHTML = originalText;
    });
}
</script>
{% endblock %} 